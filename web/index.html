<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DisBucket - Web UI</title>
    <meta name="description" content="Manage Discord Object Store batches with a modern web UI.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        discord: {
                            bg: '#313338',
                            sidebar: '#2b2d31',
                            element: '#1e1f22',
                            hover: '#3f4147',
                            active: '#35373c',
                            light: '#b5bac1',
                            white: '#f2f3f5',
                            divider: '#1f2023',
                            brand: '#5865F2',
                            brandHover: '#4752c4',
                            success: '#23a559',
                            danger: '#da373c',
                            warning: '#f0b232',
                            info: '#00a8fc'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 10s infinite',
                        'bounce': 'bounce 1s ease-in-out 3',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(88, 101, 242, 0.15)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Respect user motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background-color: #2b2d31; 
        }
        ::-webkit-scrollbar-thumb {
            background-color: #1a1b1e; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #5865F2;
        }

        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .view-section.active {
            display: block;
            opacity: 1;
        }

        input[type="text"], textarea, select, button:focus-visible {
            outline: none;
            transition: all 0.2s ease;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: #5865F2;
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
        }
        
        /* Visible focus states for accessibility */
        button:focus-visible, a:focus-visible {
            outline: 2px solid #5865F2;
            outline-offset: 2px;
        }
        
        /* Loading skeleton */
        .skeleton {
            animation: skeleton-loading 1.5s infinite;
            background: linear-gradient(90deg, #2b2d31 25%, #3f4147 50%, #2b2d31 75%);
            background-size: 200% 100%;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23B5BAC166' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%235865F2' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            background-color: rgba(88, 101, 242, 0.05);
        }
        
        /* Terminal texture - subtle scanline effect */
        #job-logs {
            background-image: 
                repeating-linear-gradient(0deg, rgba(255,255,255,0.005) 0px, transparent 1px, transparent 2px);
        }
        
        /* Toast notification */
        .toast {
            animation: toast-in 0.3s ease-out forwards;
            transition: all 0.3s ease;
        }
        @keyframes toast-in {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Clear search button */
        .clear-search {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .clear-search.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        /* Chevron icon rotation */
        .chevron-icon {
            transition: transform 0.2s ease;
        }
        
        /* Button disabled state */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }

        /* Font Awesome Animations */
        .fa-beat {
            animation: fa-beat 1s ease-in-out infinite;
        }
        @keyframes fa-beat {
            0%, 90% { transform: scale(1); }
            45% { transform: scale(1.15); }
        }

        .fa-fade {
            animation: fa-fade 1s ease-in-out infinite;
        }
        @keyframes fa-fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .fa-bounce {
            animation: fa-bounce 1s ease-in-out 3;
        }
        @keyframes fa-bounce {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-10px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(-5px); }
        }

        .fa-spin {
            animation: fa-spin 1s linear infinite;
        }
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress bar animations */
        .progress-container {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Mobile sidebar */
        @media (max-width: 1023px) {
            aside {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 50;
            }
            aside.mobile-open {
                transform: translateX(0);
            }
            .mobile-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            .mobile-overlay.active {
                display: block;
            }
        }

        /* Shimmer effect for progress bar */
        .progress-container .h-full::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body class="bg-discord-bg text-discord-white font-sans h-screen flex overflow-hidden selection:bg-discord-brand selection:text-white">
    
    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobileSidebar()"></div>

    <aside class="w-72 bg-discord-sidebar flex flex-col border-r border-discord-divider shrink-0 z-30 shadow-[4px_0_20px_rgba(0,0,0,0.3)]" id="sidebar" role="navigation" aria-label="Main navigation">
        <div class="h-20 flex items-center px-6 border-b border-discord-divider shrink-0 gap-3">
            <div class="w-10 h-10 rounded-xl bg-discord-brand flex items-center justify-center shadow-glow">
                <i class="fa-solid fa-cubes text-2xl text-white"></i>
            </div>
            <div>
                <h1 class="font-extrabold text-lg tracking-tight leading-none text-white">DisBucket - Web UI</h1>
                <span class="text-[10px] font-mono text-discord-brand uppercase tracking-wider font-bold">Version v4.0.0</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <div class="text-xs font-bold text-discord-light uppercase tracking-wider px-4 mb-2 opacity-80">Menu</div>
            
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3 rounded-xl transition-all group active text-discord-white bg-discord-brand/10 text-discord-brand" aria-current="page" aria-label="Dashboard - View statistics and recent activity">
                <i class="fa-solid fa-chart-pie w-6 text-center text-lg group-hover:scale-110 transition-transform" aria-hidden="true"></i>
                <span class="font-medium text-sm ml-3">Dashboard</span>
                <span class="ml-auto text-[10px] opacity-50 font-mono">D</span>
            </button>

            <button onclick="switchView('upload')" id="nav-upload" class="nav-item w-full flex items-center px-4 py-3 text-discord-light hover:bg-discord-hover hover:text-discord-white rounded-xl transition-all group" aria-label="Upload - Upload new artifacts">
                <i class="fa-solid fa-cloud-arrow-up w-6 text-center text-lg group-hover:scale-110 transition-transform" aria-hidden="true"></i>
                <span class="font-medium text-sm ml-3">Upload Artifact</span>
                <span class="ml-auto text-[10px] opacity-50 font-mono">U</span>
            </button>

            <button onclick="switchView('batches')" id="nav-batches" class="nav-item w-full flex items-center px-4 py-3 text-discord-light hover:bg-discord-hover hover:text-discord-white rounded-xl transition-all group" aria-label="File Batches - Browse and manage uploaded batches">
                <i class="fa-solid fa-layer-group w-6 text-center text-lg group-hover:scale-110 transition-transform" aria-hidden="true"></i>
                <span class="font-medium text-sm ml-3">File Batches</span>
                <span class="ml-auto text-[10px] opacity-50 font-mono">B</span>
            </button>

            <div class="my-4 border-t border-discord-divider mx-2"></div>
            <div class="text-xs font-bold text-discord-light uppercase tracking-wider px-4 mb-2 opacity-80">System</div>

            <button onclick="switchView('actions')" id="nav-actions" class="nav-item w-full flex items-center px-4 py-3 text-discord-light hover:bg-discord-hover hover:text-discord-white rounded-xl transition-all group" aria-label="Maintenance - System maintenance and backup options">
                <i class="fa-solid fa-sliders w-6 text-center text-lg group-hover:scale-110 transition-transform" aria-hidden="true"></i>
                <span class="font-medium text-sm ml-3">Maintenance</span>
                <span class="ml-auto text-[10px] opacity-50 font-mono">M</span>
            </button>
        </nav>

        <div class="p-4 bg-discord-element/50 border-t border-discord-divider shrink-0">
            <div class="flex items-center gap-3 bg-discord-bg/50 p-3 rounded-xl border border-discord-divider/50">
                <div class="relative">
                    <div class="w-10 h-10 rounded-full bg-discord-element flex items-center justify-center border border-discord-divider">
                        <i class="fa-solid fa-server text-discord-light"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-discord-bg rounded-full flex items-center justify-center">
                        <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse-slow shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="text-sm font-bold text-white truncate">DisBucket Server</div>
                    <div class="text-[11px] text-discord-light font-mono truncate">Web UI: <span class="text-green-400">Connected</span></div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-discord-bg">
        <!-- Animated Gradient Blobs -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none z-0 opacity-30">
            <div class="absolute top-[-10%] left-[-5%] w-[500px] h-[500px] bg-discord-brand/30 rounded-full blur-[120px] animate-blob"></div>
            <div class="absolute bottom-[5%] right-[-5%] w-[450px] h-[450px] bg-purple-600/25 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
        </div>

        <header class="h-20 bg-discord-bg/95 backdrop-blur-sm border-b border-discord-divider flex items-center justify-between px-4 lg:px-8 shrink-0 z-20 sticky top-0">
            <div class="flex items-center gap-4 flex-1 min-w-0">
                <button id="mobile-menu-btn" class="lg:hidden w-10 h-10 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light hover:text-white border border-discord-divider transition-all flex items-center justify-center" aria-label="Toggle menu" aria-expanded="false">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="flex flex-col justify-center min-w-0">
                     <h2 id="page-title" class="text-lg lg:text-xl font-bold text-white tracking-tight">Dashboard</h2>
                     <div class="hidden sm:flex items-center text-xs text-discord-light mt-1 font-mono">
                        <i class="fa-solid fa-clock mr-2 opacity-60" aria-hidden="true"></i>
                        <span>Last updated: <span id="last-updated">just now</span></span>
                     </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 lg:gap-4">
                <div class="relative group">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-discord-light group-focus-within:text-discord-brand transition-colors pointer-events-none" aria-hidden="true"></i>
                    <input id="global-search" type="text" placeholder="Search... (/)" class="bg-discord-element border border-discord-divider rounded-full py-2 pl-10 pr-10 text-sm w-40 lg:w-64 text-white focus:w-48 lg:focus:w-72 transition-all shadow-sm" aria-label="Global search">
                    <button id="clear-search-btn" class="clear-search absolute right-3 top-1/2 transform -translate-y-1/2 text-discord-light hover:text-white transition-colors" aria-label="Clear search">
                        <i class="fa-solid fa-times text-xs" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="relative group hidden lg:block">
                    <button class="w-10 h-10 rounded-full bg-discord-element hover:bg-discord-hover text-discord-light hover:text-white border border-discord-divider transition-all flex items-center justify-center shadow-sm" aria-label="Keyboard shortcuts" title="Keyboard shortcuts">
                        <i class="fa-solid fa-keyboard text-sm" aria-hidden="true"></i>
                    </button>
                    <div class="absolute right-0 top-12 bg-discord-sidebar border border-discord-divider rounded-xl p-4 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all w-64 z-50">
                        <h4 class="text-xs font-bold text-discord-light uppercase tracking-wider mb-3">Keyboard Shortcuts</h4>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between items-center"><span class="text-discord-light">Dashboard</span><kbd class="bg-discord-element px-2 py-1 rounded font-mono text-white">D</kbd></div>
                            <div class="flex justify-between items-center"><span class="text-discord-light">Upload</span><kbd class="bg-discord-element px-2 py-1 rounded font-mono text-white">U</kbd></div>
                            <div class="flex justify-between items-center"><span class="text-discord-light">Batches</span><kbd class="bg-discord-element px-2 py-1 rounded font-mono text-white">B</kbd></div>
                            <div class="flex justify-between items-center"><span class="text-discord-light">Maintenance</span><kbd class="bg-discord-element px-2 py-1 rounded font-mono text-white">M</kbd></div>
                            <div class="flex justify-between items-center"><span class="text-discord-light">Search</span><kbd class="bg-discord-element px-2 py-1 rounded font-mono text-white">/</kbd></div>
                            <div class="flex justify-between items-center"><span class="text-discord-light">Refresh</span><kbd class="bg-discord-element px-2 py-1 rounded font-mono text-white">R</kbd></div>
                        </div>
                    </div>
                </div>
                <button id="refresh-btn" class="w-10 h-10 rounded-full bg-discord-element hover:bg-discord-brand text-discord-light hover:text-white border border-discord-divider hover:border-discord-brand transition-all flex items-center justify-center shadow-sm" title="Refresh Data (R)" aria-label="Refresh data">
                    <i class="fa-solid fa-rotate" aria-hidden="true"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 scroll-smooth relative z-10" id="main-container">
            
            <section id="dashboard" class="view-section active animate-fade-in space-y-8" role="region" aria-label="Dashboard overview">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider hover:border-purple-500/30 relative overflow-hidden group hover:-translate-y-1 hover:shadow-[0_0_20px_rgba(168,85,247,0.15)] transition-all duration-300">
                        <div class="absolute top-0 left-0 w-1 h-full bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.5)]"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-10 group-hover:opacity-15 group-hover:scale-110 transition-all" aria-hidden="true">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Total Batches</h3>
                                <div id="stat-batches" class="text-3xl font-extrabold text-white skeleton rounded" style="min-width: 60px; min-height: 40px;">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 border border-purple-500/20">
                                <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            <span class="text-green-400"><i class="fa-solid fa-arrow-up" aria-hidden="true"></i> Live</span> tracking enabled
                        </div>
                    </div>

                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider hover:border-green-500/30 relative overflow-hidden group hover:-translate-y-1 hover:shadow-[0_0_20px_rgba(34,197,94,0.15)] transition-all duration-300">
                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-10 group-hover:opacity-15 group-hover:scale-110 transition-all" aria-hidden="true">
                            <i class="fa-solid fa-hard-drive"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Total Size</h3>
                                <div id="stat-total" class="text-3xl font-extrabold text-white skeleton rounded" style="min-width: 80px; min-height: 40px;">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-400 border border-green-500/20">
                                <i class="fa-solid fa-hard-drive" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            Remote storage usage
                        </div>
                    </div>

                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider hover:border-blue-500/30 relative overflow-hidden group hover:-translate-y-1 hover:shadow-[0_0_20px_rgba(59,130,246,0.15)] transition-all duration-300">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-10 group-hover:opacity-15 group-hover:scale-110 transition-all" aria-hidden="true">
                            <i class="fa-regular fa-file-zipper"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Compressed</h3>
                                <div id="stat-compressed" class="text-3xl font-extrabold text-white skeleton rounded" style="min-width: 80px; min-height: 40px;">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
                                <i class="fa-regular fa-file-zipper" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            Optimized storage
                        </div>
                    </div>

                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider hover:border-yellow-500/30 relative overflow-hidden group hover:-translate-y-1 hover:shadow-[0_0_20px_rgba(234,179,8,0.15)] transition-all duration-300">
                        <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-10 group-hover:opacity-15 group-hover:scale-110 transition-all" aria-hidden="true">
                            <i class="fa-solid fa-puzzle-piece"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Chunks</h3>
                                <div id="stat-chunks" class="text-3xl font-extrabold text-white skeleton rounded" style="min-width: 60px; min-height: 40px;">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-yellow-500/10 flex items-center justify-center text-yellow-500 border border-yellow-500/20">
                                <i class="fa-solid fa-puzzle-piece" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            Distributed file parts
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 animate-slide-up">
                    <div class="bg-discord-element rounded-2xl border border-discord-divider flex flex-col shadow-2xl overflow-hidden min-h-[400px]" role="region" aria-label="Job logs">
                        <div class="bg-[#2b2d31] px-5 py-3 border-b border-discord-divider flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <span class="font-mono text-xs text-discord-light flex items-center gap-2">
                                    <i class="fa-solid fa-terminal text-discord-brand" aria-hidden="true"></i>
                                    <span class="hidden sm:inline">bot.py â€” </span>active job
                                </span>
                            </div>
                            <div id="job-summary" class="text-xs font-mono font-bold text-discord-light uppercase bg-discord-bg px-3 py-1 rounded-md border border-discord-divider" role="status">
                                IDLE
                            </div>
                        </div>

                        <div class="h-1 bg-discord-bg w-full" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <div id="job-progress" class="h-full bg-gradient-to-r from-discord-brand to-purple-500 transition-all duration-300 ease-out shadow-[0_0_10px_rgba(88,101,242,0.5)]" style="width: 0%;"></div>
                        </div>
                        
                        <div id="job-logs" class="flex-1 p-6 font-mono text-sm text-discord-light/90 overflow-y-auto custom-scrollbar selection:bg-discord-brand selection:text-white leading-relaxed space-y-1" role="log" aria-live="polite">
<div class="animate-fade-in"><span class="text-discord-brand"><i class="fa-solid fa-circle-check mr-2" aria-hidden="true"></i></span>System initialized.</div>
<div class="animate-fade-in"><span class="text-discord-brand"><i class="fa-solid fa-clock mr-2 fa-spin" aria-hidden="true"></i></span>Waiting for job dispatch...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-discord-sidebar rounded-2xl border border-discord-divider shadow-card">
                    <div class="px-6 py-4 border-b border-discord-divider flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-xl bg-discord-element flex items-center justify-center text-discord-brand">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                            <div>
                                <h3 class="text-base font-bold text-white">Recent Activity</h3>
                                <p class="text-xs text-discord-light">Latest uploads and batch operations</p>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-discord-brand bg-discord-brand/10 px-3 py-1 rounded-full border border-discord-brand/20">Live</span>
                    </div>
                    <div class="px-6 py-5">
                        <div class="bg-discord-element/40 border border-discord-divider/60 rounded-2xl p-5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold">Recent Activity</div>
                                <span id="activity-updated" class="text-[10px] text-discord-light font-mono">Updated just now</span>
                            </div>
                            <div id="activity-feed" class="space-y-3 text-sm text-discord-light">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="upload" class="view-section animate-fade-in space-y-6 max-w-4xl mx-auto" role="region" aria-label="Upload artifact">
                <div class="bg-discord-sidebar rounded-2xl border border-discord-divider overflow-hidden shadow-card">
                    <div class="p-6 border-b border-discord-divider">
                        <h2 class="text-2xl font-bold text-white mb-1">Upload New Artifact</h2>
                        <p class="text-discord-light text-sm">Select files or folders to compress and upload to the Object Store. Max recommended size: 25MB per file.</p>
                    </div>
                    
                    <div class="p-8">
                        <form id="upload-form" class="space-y-5">
                            <div class="space-y-3">
                                <div id="drop-area" class="drop-zone rounded-2xl p-4 flex flex-col items-center justify-center text-center cursor-pointer min-h-[140px] relative group" role="button" tabindex="0" aria-label="Upload file area">
                                    <input id="upload-file" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" aria-label="File input">
                                    
                                    <div class="w-16 h-16 bg-discord-brand/10 rounded-full flex items-center justify-center text-discord-brand mb-4 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl" aria-hidden="true"></i>
                                    </div>
                                    <h3 class="text-white font-bold text-lg mb-1">Click to browse or drag file here</h3>
                                    <p class="text-discord-light text-sm max-w-xs mx-auto">Supports individual files or directory structures (when folder mode is active).</p>
                                    <div id="file-name-display" class="mt-4 px-4 py-2 bg-discord-brand rounded-full text-xs font-bold text-white hidden animate-fade-in">
                                        <i class="fa-solid fa-file mr-2" aria-hidden="true"></i> <span id="selected-filename">filename.zip</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 mt-2 pl-1 p-3 bg-discord-element/30 rounded-lg border border-discord-divider/50">
                                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="upload-folder-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-all duration-300" aria-describedby="folder-toggle-desc"/>
                                        <label for="upload-folder-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-discord-element border border-discord-divider cursor-pointer"></label>
                                    </div>
                                    <div class="flex-1">
                                        <label for="upload-folder-toggle" class="text-sm font-medium text-white cursor-pointer select-none block">Upload as folder</label>
                                        <span id="folder-toggle-desc" class="text-xs text-discord-light">Preserves directory structure and relative paths</span>
                                    </div>
                                </div>
                                <style>
                                    #upload-folder-toggle:checked + .toggle-label {
                                        background-color: #5865F2;
                                        border-color: #5865F2;
                                    }
                                    #upload-folder-toggle:checked {
                                        right: 0;
                                        border-color: #5865F2;
                                        transform: translateX(100%);
                                    }
                                </style>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="upload-title" class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">Artifact Title</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-discord-light/50" aria-hidden="true"></i>
                                        <input id="upload-title" type="text" class="w-full bg-discord-element border border-discord-divider rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-discord-light/50 focus:border-discord-brand" placeholder="e.g. Project Phoenix Assets">
                                    </div>
                                </div>
                                <div>
                                    <label for="upload-tags" class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">Tags</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-hashtag absolute left-4 top-1/2 -translate-y-1/2 text-discord-light/50" aria-hidden="true"></i>
                                        <input id="upload-tags" type="text" class="w-full bg-discord-element border border-discord-divider rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-discord-light/50 focus:border-discord-brand" placeholder="backup, v1, release">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="upload-description" class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">Description</label>
                                <textarea id="upload-description" rows="2" class="w-full bg-discord-element border border-discord-divider rounded-xl p-4 text-sm text-white placeholder-discord-light/50 focus:border-discord-brand resize-none" placeholder="Brief summary of contents..."></textarea>
                            </div>

                            <div>
                                <label for="upload-channel" class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">
                                    Storage Channel
                                    <span class="text-discord-light/50 font-normal normal-case text-xs ml-2">(Optional - Auto round-robin if not selected)</span>
                                </label>
                                <div class="relative">
                                    <i class="fa-solid fa-hashtag absolute left-4 top-1/2 -translate-y-1/2 text-discord-light/50 pointer-events-none" aria-hidden="true"></i>
                                    <select id="upload-channel" class="w-full bg-discord-element border border-discord-divider rounded-xl py-3 pl-10 pr-10 text-sm text-white focus:border-discord-brand appearance-none cursor-pointer">
                                        <option value="">Auto (Round-Robin Distribution)</option>
                                        <option value="file-storage-vault">file-storage-vault</option>
                                        <option value="backup-storage">backup-storage</option>
                                        <option value="archive-vault">archive-vault</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-discord-light/50 pointer-events-none" aria-hidden="true"></i>
                                </div>
                                <p class="text-xs text-discord-light/70 mt-2 ml-1">
                                    <i class="fa-solid fa-circle-info mr-1" aria-hidden="true"></i>
                                    Select a specific channel or leave as Auto for automatic distribution across all channels
                                </p>
                            </div>

                            <div class="pt-6 border-t border-discord-divider flex flex-col sm:flex-row items-center justify-between gap-4">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="w-5 h-5 rounded border border-discord-divider bg-discord-element flex items-center justify-center group-hover:border-discord-brand transition-colors relative">
                                        <input id="upload-confirm" type="checkbox" class="appearance-none w-full h-full checked:bg-discord-brand rounded-sm cursor-pointer">
                                        <i class="fa-solid fa-check text-white text-[10px] absolute opacity-0 check-icon pointer-events-none" aria-hidden="true"></i>
                                        <style>
                                            #upload-confirm:checked + .check-icon { opacity: 1; }
                                        </style>
                                    </div>
                                    <span class="text-sm text-discord-light group-hover:text-white transition-colors">Require CLI Confirmation</span>
                                </label>
                                <button type="submit" class="bg-discord-brand hover:bg-discord-brandHover text-white px-10 py-3 rounded-full font-bold shadow-glow transition-all transform active:scale-95 hover:shadow-[0_0_20px_rgba(88,101,242,0.4)] text-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" id="submit-upload-btn">
                                    <i class="fa-solid fa-rocket" aria-hidden="true"></i> <span>Start Upload</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <section id="batches" class="view-section animate-fade-in space-y-6" role="region" aria-label="File batches">
                 <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between bg-discord-sidebar p-2 rounded-2xl border border-discord-divider gap-2">
                    <div class="relative w-full sm:max-w-md flex-1">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-discord-light pointer-events-none" aria-hidden="true"></i>
                        <input id="batch-search" type="text" placeholder="Filter batches..." class="w-full bg-transparent border-none rounded-xl py-3 pl-12 pr-4 text-white text-sm focus:ring-0 placeholder-discord-light/50" aria-label="Filter batches">
                        <span id="batch-count" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-xs text-discord-light font-mono" aria-live="polite"></span>
                    </div>
                    <div class="flex gap-2 pr-2">
                         <button id="batch-view-grid" class="w-9 h-9 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light flex items-center justify-center transition-colors" title="Grid View" aria-label="Switch to grid view">
                            <i class="fa-solid fa-grip" aria-hidden="true"></i>
                         </button>
                         <button id="batch-view-list" class="w-9 h-9 rounded-lg bg-discord-brand text-white flex items-center justify-center shadow-sm" title="List View" aria-label="Switch to list view" aria-pressed="true">
                            <i class="fa-solid fa-list" aria-hidden="true"></i>
                         </button>
                    </div>
                </div>

                <div class="bg-discord-sidebar border border-discord-divider rounded-2xl overflow-hidden shadow-card">
                    <div id="batch-table-container" class="overflow-x-auto">
                        <table class="w-full text-sm" role="table">
                            <thead>
                                <tr class="bg-discord-element border-b border-discord-divider text-left">
                                    <th class="px-4 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider w-12" scope="col"></th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider w-32" scope="col">ID</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider" scope="col">Artifact Name</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider" scope="col">Size</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider hidden lg:table-cell" scope="col">Date</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider" scope="col">Status</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider text-right" scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="batch-table" class="divide-y divide-discord-divider">
                            </tbody>
                        </table>
                    </div>
                    <div id="batch-grid" class="hidden p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    </div>
                    <div id="empty-state" class="hidden p-12 flex flex-col items-center justify-center text-center">
                        <div class="w-20 h-20 bg-discord-element rounded-2xl flex items-center justify-center text-discord-light mb-6 border border-discord-divider relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-discord-brand/5 to-purple-500/5"></div>
                            <i class="fa-solid fa-box-open text-4xl relative z-10" aria-hidden="true"></i>
                        </div>
                        <h3 class="text-white font-bold text-xl mb-2">No Batches Found</h3>
                        <p class="text-discord-light text-sm mb-6 max-w-sm">Start by uploading your first artifact. Your files will be compressed and distributed across Discord storage channels.</p>
                        <button onclick="switchView('upload')" class="bg-discord-brand hover:bg-discord-brandHover text-white px-6 py-2.5 rounded-full font-medium shadow-glow transition-all transform hover:scale-105 text-sm flex items-center gap-2">
                            <i class="fa-solid fa-cloud-arrow-up" aria-hidden="true"></i> Upload First Artifact
                        </button>
                    </div>
                </div>
            </section>

            <section id="actions" class="view-section animate-fade-in space-y-6" role="region" aria-label="System maintenance">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-discord-sidebar border border-discord-divider flex items-center justify-center text-discord-light">
                        <i class="fa-solid fa-wrench" aria-hidden="true"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">System Maintenance</h2>
                        <p class="text-xs text-discord-light">Manage local database and synchronization.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-discord-brand/50 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity" aria-hidden="true">
                            <i class="fa-solid fa-arrows-rotate text-6xl text-white"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-white mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Sync from Discord</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Fetch latest metadata and verify integrity of remote channels.</p>
                        <button id="sync-btn" class="w-full bg-discord-element hover:bg-discord-brand hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all" aria-label="Sync from Discord">
                            Run Sync
                        </button>
                    </div>

                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-red-500/50 transition-all group relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity" aria-hidden="true">
                            <i class="fa-solid fa-bomb text-6xl text-red-500"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-red-500 mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Hard Reset</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Rebuild local DB from scratch. <span class="text-red-400">Destructive action.</span></p>
                        <button id="sync-reset-btn" class="w-full bg-discord-element hover:bg-red-500 hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all" aria-label="Hard reset database">
                            Run Reset
                        </button>
                    </div>

                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-green-500/50 transition-all group relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity" aria-hidden="true">
                            <i class="fa-solid fa-floppy-disk text-6xl text-green-500"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-green-400 mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Local Backup</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Dump local DB to a JSON file for safe keeping.</p>
                        <button id="backup-btn" class="w-full bg-discord-element hover:bg-green-600 hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all" aria-label="Create local backup">
                            Create Backup
                        </button>
                    </div>

                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-discord-brand/50 transition-all group relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity" aria-hidden="true">
                            <i class="fa-solid fa-cloud-arrow-up text-6xl text-discord-brand"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-discord-brand mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up" aria-hidden="true"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Cloud Backup</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Backup DB and upload directly to a Discord thread.</p>
                        <button id="backup-upload-btn" class="w-full bg-discord-element hover:bg-discord-brand hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all" aria-label="Backup and upload to Discord">
                            Backup + Upload
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            const isOpen = sidebar.classList.contains('mobile-open');
            menuBtn.setAttribute('aria-expanded', isOpen);
        }
        
        // Initialize mobile menu button
        document.addEventListener('DOMContentLoaded', () => {
            const menuBtn = document.getElementById('mobile-menu-btn');
            if (menuBtn) {
                menuBtn.addEventListener('click', toggleMobileSidebar);
            }
        });
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const icons = {
                success: 'fa-circle-check',
                error: 'fa-circle-xmark',
                info: 'fa-circle-info',
                warning: 'fa-triangle-exclamation'
            };
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-discord-brand',
                warning: 'bg-yellow-500'
            };
            
            toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 max-w-sm pointer-events-auto`;
            toast.innerHTML = `<i class="fa-solid ${icons[type]}" aria-hidden="true"></i><span>${escapeHtml(message)}</span>`;
            
            const container = document.getElementById('notification-container') || document.body;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Update last updated time
        function updateLastUpdatedTime() {
            const lastUpdated = document.getElementById('last-updated');
            if (lastUpdated) {
                const now = new Date();
                lastUpdated.textContent = now.toLocaleTimeString(undefined, { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }
    
        function switchView(viewName) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-discord-brand/10', 'text-discord-brand', 'active');
                el.classList.add('text-discord-light');
                el.removeAttribute('aria-current');
            });
            
            const activeNav = document.getElementById(`nav-${viewName}`);
            if (activeNav) {
                activeNav.classList.remove('text-discord-light');
                activeNav.classList.add('bg-discord-brand/10', 'text-discord-brand', 'active');
                activeNav.setAttribute('aria-current', 'page');
            }

            let displayName = viewName.charAt(0).toUpperCase() + viewName.slice(1);
            if (viewName === 'batches') displayName = 'File Batches';
            if (viewName === 'actions') displayName = 'Maintenance';
            document.getElementById('page-title').textContent = displayName;

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if (!el.classList.contains('active')) el.style.display = 'none';
                }, 200);
            });

            const target = document.getElementById(viewName);
            if (target) {
                target.style.display = 'block';
                void target.offsetWidth;
                target.classList.add('active');
            }
            
            // Close mobile sidebar on view switch
            if (window.innerWidth < 1024) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                // Allow "/" to focus search even when in input
                if (e.key === '/' && !e.target.id.includes('search')) {
                    e.preventDefault();
                    document.getElementById('global-search').focus();
                }
                return;
            }
            
            if (e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                switchView('dashboard');
            } else if (e.key === 'u' || e.key === 'U') {
                e.preventDefault();
                switchView('upload');
            } else if (e.key === 'b' || e.key === 'B') {
                e.preventDefault();
                switchView('batches');
            } else if (e.key === 'm' || e.key === 'M') {
                e.preventDefault();
                switchView('actions');
            } else if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                document.getElementById('refresh-btn').click();
            } else if (e.key === '/') {
                e.preventDefault();
                document.getElementById('global-search').focus();
            } else if (e.key === 'Escape') {
                // Clear search on escape
                const globalSearch = document.getElementById('global-search');
                const batchSearch = document.getElementById('batch-search');
                if (globalSearch.value) {
                    globalSearch.value = '';
                    globalSearch.dispatchEvent(new Event('input'));
                } else if (batchSearch && batchSearch.value) {
                    batchSearch.value = '';
                    batchSearch.dispatchEvent(new Event('input'));
                }
            }
        });
        
        // Clear search button
        const clearSearchBtn = document.getElementById('clear-search-btn');
        const globalSearchInput = document.getElementById('global-search');
        
        if (clearSearchBtn && globalSearchInput) {
            clearSearchBtn.addEventListener('click', () => {
                globalSearchInput.value = '';
                globalSearchInput.dispatchEvent(new Event('input'));
                globalSearchInput.focus();
            });
            
            globalSearchInput.addEventListener('input', () => {
                if (globalSearchInput.value) {
                    clearSearchBtn.classList.add('visible');
                } else {
                    clearSearchBtn.classList.remove('visible');
                }
            });
        }
    
        const uploadToggle = document.getElementById('upload-folder-toggle');
        const uploadInput = document.getElementById('upload-file');
        const fileNameDisplay = document.getElementById('selected-filename');
        const fileNameContainer = document.getElementById('file-name-display');
        const dropArea = document.getElementById('drop-area');

        const updateUploadMode = () => {
            if (uploadToggle.checked) {
                uploadInput.setAttribute('webkitdirectory', '');
                uploadInput.setAttribute('multiple', '');
            } else {
                uploadInput.removeAttribute('webkitdirectory');
                uploadInput.removeAttribute('multiple');
            }
            uploadInput.value = '';
            fileNameContainer.classList.add('hidden');
        };

        uploadToggle.addEventListener('change', updateUploadMode);
        
        uploadInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameContainer.classList.remove('hidden');
                if (this.files.length === 1) {
                    fileNameDisplay.textContent = this.files[0].name;
                } else {
                    fileNameDisplay.textContent = `${this.files.length} files selected`;
                }
            } else {
                fileNameContainer.classList.add('hidden');
            }
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('drag-over');
        }
        function unhighlight() {
            dropArea.classList.remove('drag-over');
        }
        
        // Keyboard support for drop area
        dropArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                uploadInput.click();
            }
        });

        const jobSummary = document.getElementById('job-summary');
        const jobLogs = document.getElementById('job-logs');
        const jobProgress = document.getElementById('job-progress');
        let activeJobId = null;
        let jobTimer = null;

        const formatBytes = (bytes) => {
            if (!bytes && bytes !== 0) return '--';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex += 1;
            }
            return `${size.toFixed(unitIndex === 0 ? 0 : 2)} ${units[unitIndex]}`;
        };

        const openFolderInFinder = async (path) => {
            try {
                // Try to open the folder using the API
                const res = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                
                if (res.ok) {
                    // Show a brief success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-8 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
                    notification.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>Folder opened in Finder';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 2000);
                } else {
                    throw new Error('Failed to open folder');
                }
            } catch (e) {
                // Fallback: copy path to clipboard
                navigator.clipboard.writeText(path).then(() => {
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-8 bg-discord-brand text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
                    notification.innerHTML = '<i class="fa-solid fa-copy mr-2"></i>Path copied to clipboard';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 2000);
                });
            }
        };

        const startJob = (jobId) => {
            activeJobId = jobId;
            jobSummary.textContent = `JOB #${jobId}`;
            jobSummary.className = "text-xs font-mono font-bold text-discord-brand uppercase bg-discord-brand/10 px-3 py-1 rounded-md border border-discord-brand/20";
            
            jobLogs.innerHTML = '<div class="text-discord-brand animate-fade-in"><i class="fa-solid fa-rocket mr-2"></i>Initializing job sequence...</div>';
            jobProgress.style.width = '0%';
            
            switchView('dashboard');
            
            if (jobTimer) clearInterval(jobTimer);
            jobTimer = setInterval(refreshJob, 1000);
            refreshJob();
        };

        const createProgressBar = (percent, label, jobType = 'upload') => {
            const container = document.createElement('div');
            container.className = 'progress-container my-3 animate-fade-in';
            container.dataset.progressType = 'bar';
            
            // Choose icon based on job type
            let icon = 'fa-spinner fa-spin';
            let iconColor = 'text-discord-brand';
            if (label.toLowerCase().includes('upload')) {
                icon = 'fa-cloud-arrow-up fa-fade';
                iconColor = 'text-purple-400';
            } else if (label.toLowerCase().includes('download')) {
                icon = 'fa-cloud-arrow-down fa-beat';
                iconColor = 'text-blue-400';
            } else if (label.toLowerCase().includes('receiv')) {
                icon = 'fa-inbox';
                iconColor = 'text-green-400';
            }
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'flex items-center justify-between text-xs mb-2';
            labelDiv.innerHTML = `
                <span class="text-discord-light flex items-center">
                    <i class="fa-solid ${icon} mr-2 ${iconColor}"></i>
                    <span>${escapeHtml(label)}</span>
                </span>
                <span class="text-discord-brand font-bold tabular-nums">${percent}%</span>
            `;
            
            const barBg = document.createElement('div');
            barBg.className = 'w-full h-2.5 bg-discord-element rounded-full overflow-hidden border border-discord-divider/50 shadow-inner';
            
            const barFill = document.createElement('div');
            barFill.className = 'h-full bg-gradient-to-r from-discord-brand via-blue-500 to-purple-500 rounded-full transition-all duration-500 ease-out relative';
            barFill.style.width = `${percent}%`;
            barFill.style.boxShadow = '0 0 10px rgba(88, 101, 242, 0.6)';
            
            barBg.appendChild(barFill);
            container.appendChild(labelDiv);
            container.appendChild(barBg);
            
            return container;
        };

        const formatLogLine = (line) => {
            // Check if this is a progress line
            if (line.startsWith('PROGRESS:')) {
                return null; // Will be handled separately
            }
            
            // Add icons to common log patterns
            line = line.replace(/^Receiving upload\.\.\./, '<span class="text-blue-400"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Receiving upload...</span>');
            line = line.replace(/^Saved (\d+) file\(s\)\./, '<span class="text-green-400"><i class="fa-solid fa-check-circle mr-2"></i>Saved $1 file(s).</span>');
            line = line.replace(/^Starting Discord upload\.\.\./, '<span class="text-discord-brand"><i class="fa-solid fa-rocket mr-2 fa-fade"></i>Starting Discord upload...</span>');
            line = line.replace(/^Upload complete\./, '<span class="text-green-400"><i class="fa-solid fa-circle-check mr-2"></i>Upload complete.</span>');
            line = line.replace(/^Restoring batch to (.+)\.\.\./, '<span class="text-blue-400"><i class="fa-solid fa-download mr-2 fa-beat"></i>Restoring batch to $1...</span>');
            line = line.replace(/Batch ID: ([A-Z0-9_]+)/, 'Batch ID: <span class="text-discord-brand font-bold">$1</span>');
            
            return line;
        };

        const createInteractiveResult = (result, jobType) => {
            const container = document.createElement('div');
            container.className = 'mt-2 mb-2';
            
            const header = document.createElement('div');
            header.className = 'text-green-400 font-bold mb-2';
            header.innerHTML = '<i class="fa-solid fa-circle-check mr-2 fa-bounce"></i>SUCCESS RESULT:';
            container.appendChild(header);
            
            const resultBox = document.createElement('div');
            resultBox.className = 'bg-discord-sidebar border border-green-500/30 rounded-lg p-3 space-y-2 animate-fade-in';
            
            if (jobType === 'download' && result.restored_path) {
                // Make download path clickable
                const pathItem = document.createElement('div');
                pathItem.className = 'flex items-start gap-2';
                pathItem.innerHTML = `
                    <span class="text-discord-light text-sm">restored_path:</span>
                    <button class="text-discord-brand hover:text-blue-300 underline text-sm font-mono break-all text-left transition-colors group flex items-center gap-1" onclick="openFolderInFinder('${escapeHtml(result.restored_path)}')">
                        <i class="fa-solid fa-folder-open mr-1 group-hover:scale-110 transition-transform"></i>
                        "${escapeHtml(result.restored_path)}"
                        <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs opacity-50 group-hover:opacity-100"></i>
                    </button>
                `;
                resultBox.appendChild(pathItem);
            } else {
                // Display all result fields with icons
                Object.entries(result).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-start gap-2';
                    
                    let icon = 'fa-circle-info';
                    if (key.includes('id')) icon = 'fa-fingerprint';
                    if (key.includes('path')) icon = 'fa-folder';
                    if (key.includes('batch')) icon = 'fa-layer-group';
                    
                    const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : value;
                    item.innerHTML = `
                        <i class="fa-solid ${icon} text-discord-brand text-xs mt-1"></i>
                        <span class="text-discord-light text-sm">${escapeHtml(key)}:</span>
                        <span class="text-white text-sm font-mono break-all">"${escapeHtml(String(displayValue))}"</span>
                    `;
                    resultBox.appendChild(item);
                });
            }
            
            container.appendChild(resultBox);
            return container;
        };

        const refreshJob = async () => {
            if (!activeJobId) return;
            try {
                const res = await fetch(`/api/jobs/${activeJobId}`);
                if (!res.ok) {
                    jobSummary.textContent = 'JOB NOT FOUND';
                    clearInterval(jobTimer);
                    return;
                }
                const data = await res.json();
                
                let statusColor = 'text-discord-light';
                let statusIcon = 'fa-circle';
                if(data.status === 'complete') {
                    statusColor = 'text-green-400';
                    statusIcon = 'fa-circle-check';
                }
                if(data.status === 'failed') {
                    statusColor = 'text-red-400';
                    statusIcon = 'fa-circle-xmark';
                }
                if(data.status === 'running') {
                    statusColor = 'text-discord-brand';
                    statusIcon = 'fa-circle-notch fa-spin';
                }

                jobSummary.innerHTML = `<span class="${statusColor}"><i class="fa-solid ${statusIcon} mr-2"></i>${data.type.toUpperCase()} â€¢ ${data.status.toUpperCase()}</span>`;
                
                // Clear and rebuild logs container
                jobLogs.innerHTML = '';
                
                let lastProgressBar = null;
                let latestProgressInfo = null;
                
                // Process logs and extract progress info
                const logs = (data.logs || []).slice();
                const nonProgressLogs = [];
                
                logs.forEach((log, index) => {
                    if (log.startsWith('PROGRESS:')) {
                        // Parse progress: PROGRESS:percent:message
                        const parts = log.split(':');
                        if (parts.length >= 3) {
                            latestProgressInfo = {
                                percent: parseInt(parts[1]),
                                message: parts.slice(2).join(':')
                            };
                        }
                    } else {
                        nonProgressLogs.push(log);
                    }
                });
                
                // Render non-progress logs
                nonProgressLogs.forEach(log => {
                    const formatted = formatLogLine(escapeHtml(log));
                    if (formatted) {
                        const logLine = document.createElement('div');
                        logLine.className = 'mb-1 animate-fade-in';
                        logLine.innerHTML = formatted;
                        jobLogs.appendChild(logLine);
                    }
                });
                
                // Add or update progress bar if we have progress info
                if (latestProgressInfo && data.status === 'running') {
                    lastProgressBar = createProgressBar(latestProgressInfo.percent, latestProgressInfo.message, data.type);
                    jobLogs.appendChild(lastProgressBar);
                }
                
                // Add error with animation
                if (data.error) {
                    const errorLine = document.createElement('div');
                    errorLine.className = 'text-red-400 font-bold mt-2 animate-fade-in';
                    errorLine.innerHTML = `<i class="fa-solid fa-circle-xmark mr-2 fa-beat"></i>CRITICAL ERROR: ${escapeHtml(data.error)}`;
                    jobLogs.appendChild(errorLine);
                }
                
                // Add interactive result
                if (data.result) {
                    const resultElement = createInteractiveResult(data.result, data.type);
                    jobLogs.appendChild(resultElement);
                }
                
                jobProgress.style.width = `${data.progress || 0}%`;
                jobLogs.scrollTop = jobLogs.scrollHeight;
                
                if (data.status === 'complete' || data.status === 'failed') {
                    clearInterval(jobTimer);
                    // Remove progress bar on completion
                    const progressBars = jobLogs.querySelectorAll('[data-progress-type="bar"]');
                    progressBars.forEach(bar => bar.remove());
                    
                    if(data.status === 'complete') {
                        loadStats();
                        loadBatches();
                    }
                }
            } catch (e) {
                console.error("Poll error", e);
            }
        };

        const loadStats = async () => {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                
                const statBatches = document.getElementById('stat-batches');
                const statTotal = document.getElementById('stat-total');
                const statCompressed = document.getElementById('stat-compressed');
                const statChunks = document.getElementById('stat-chunks');
                
                // Remove skeleton loading
                [statBatches, statTotal, statCompressed, statChunks].forEach(el => {
                    if (el) el.classList.remove('skeleton');
                });
                
                statBatches.textContent = stats.batch_count ?? '--';
                statTotal.textContent = formatBytes(stats.total_size);
                statCompressed.textContent = formatBytes(stats.compressed_size);
                statChunks.textContent = stats.chunk_count ?? '--';
                
                updateLastUpdatedTime();
            } catch (e) { 
                console.log("Stats load error"); 
                showToast('Failed to load statistics', 'error');
            }
        };

        const batchSearchInput = document.getElementById('batch-search');
        let globalSearchTerm = '';
        let batchSearchTerm = '';
        let allBatches = [];

        const normalizeSearch = (value) => value.trim().toLowerCase();

        const getFilteredBatches = () => {
            const query = normalizeSearch(`${globalSearchTerm} ${batchSearchTerm}`);
            if (!query) return allBatches;
            const terms = query.split(/\s+/).filter(Boolean);
            return allBatches.filter((batch) => {
                const haystack = [
                    batch.batch_id,
                    batch.original_name,
                    batch.status,
                    batch.title,
                    batch.tags,
                    batch.description
                ].join(' ').toLowerCase();
                return terms.every((term) => haystack.includes(term));
            });
        };

        const formatDate = (value) => {
            if (!value) return '--';
            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) return '--';
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            return parsed.toLocaleDateString(undefined, {
                month: 'short',
                day: '2-digit',
                year: 'numeric',
                timeZone,
            });
        };

        const escapeHtml = (value) => {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        const renderActivity = () => {
            const feed = document.getElementById('activity-feed');
            const updated = document.getElementById('activity-updated');
            if (!feed || !updated) return;

            feed.innerHTML = '';
            const items = Array.isArray(allBatches) ? allBatches.slice(0, 3) : [];

            if (!items.length) {
                updated.textContent = 'No activity yet';
                feed.innerHTML = `
                    <div class="text-xs text-discord-light">Upload a batch to see activity.</div>
                `;
                return;
            }

            const statusMap = {
                complete: {
                    dot: 'bg-green-400',
                    title: 'Uploaded batch',
                },
                uploading: {
                    dot: 'bg-discord-brand',
                    title: 'Uploading batch',
                },
                failed: {
                    dot: 'bg-red-400',
                    title: 'Upload failed',
                },
            };

            items.forEach((batch) => {
                const statusInfo = statusMap[batch.status] || {
                    dot: 'bg-yellow-400',
                    title: 'Batch update',
                };
                const name = escapeHtml(batch.original_name || `Batch ${batch.batch_id}`);
                const fileCount = batch.file_count ? `${batch.file_count} files` : 'Files count unavailable';
                const when = formatDate(batch.upload_date);
                const shortId = escapeHtml(batch.batch_id ? batch.batch_id.slice(0, 6) : '');

                const item = document.createElement('div');
                item.className = 'flex items-start gap-3';
                item.innerHTML = `
                    <div class="w-2 h-2 rounded-full ${statusInfo.dot} mt-2"></div>
                    <div>
                        <div class="font-semibold text-white">${statusInfo.title}</div>
                        <div>${name} â€¢ ${fileCount} â€¢ ${when}${shortId ? ` â€¢ #${shortId}` : ''}</div>
                    </div>
                `;
                feed.appendChild(item);
            });

            updated.textContent = `Updated ${formatDate(items[0].upload_date)}`;
        };

        let batchView = 'list';

        const updateBatchViewToggle = (view) => {
            const gridBtn = document.getElementById('batch-view-grid');
            const listBtn = document.getElementById('batch-view-list');
            if (!gridBtn || !listBtn) return;

            if (view === 'grid') {
                gridBtn.className = 'w-9 h-9 rounded-lg bg-discord-brand text-white flex items-center justify-center shadow-sm';
                listBtn.className = 'w-9 h-9 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light flex items-center justify-center transition-colors';
            } else {
                listBtn.className = 'w-9 h-9 rounded-lg bg-discord-brand text-white flex items-center justify-center shadow-sm';
                gridBtn.className = 'w-9 h-9 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light flex items-center justify-center transition-colors';
            }
        };

        const setBatchView = (view) => {
            batchView = view;
            updateBatchViewToggle(view);
            renderBatches();
            
            // Save preference to localStorage
            try {
                localStorage.setItem('disbucket_batch_view', view);
            } catch (e) {
                console.log('LocalStorage not available');
            }
            
            // Update aria-pressed
            const gridBtn = document.getElementById('batch-view-grid');
            const listBtn = document.getElementById('batch-view-list');
            if (gridBtn && listBtn) {
                gridBtn.setAttribute('aria-pressed', view === 'grid');
                listBtn.setAttribute('aria-pressed', view === 'list');
            }
        };

        const getStatusBadge = (status) => {
            if (status === 'complete') {
                return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-green-500/10 text-green-400 border border-green-500/20">Synced</span>`;
            }
            if (status === 'failed') {
                return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-red-500/10 text-red-400 border border-red-500/20">Failed</span>`;
            }
            if (status === 'uploading') {
                return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-discord-brand/10 text-discord-brand border border-discord-brand/20">Uploading</span>`;
            }
            return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-discord-bg text-discord-light border border-discord-divider">${status}</span>`;
        };

        const renderBatchesList = (batchesToRender) => {
            const table = document.getElementById('batch-table');
            table.innerHTML = '';

            batchesToRender.forEach((batch) => {
                const row = document.createElement('tr');
                row.className = 'group hover:bg-discord-hover/50 transition-colors cursor-pointer';
                row.dataset.batchId = batch.batch_id;
                row.setAttribute('role', 'button');
                row.setAttribute('aria-expanded', 'false');
                row.setAttribute('tabindex', '0');

                const statusBadge = getStatusBadge(batch.status);

                row.innerHTML = `
                    <td class="px-4 py-4 text-discord-light group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-xs transition-transform chevron-icon" aria-hidden="true"></i>
                    </td>
                    <td class="px-6 py-4 font-mono text-xs text-discord-light group-hover:text-white transition-colors">
                        <span class="opacity-70">#</span>${escapeHtml(batch.batch_id)}
                    </td>
                    <td class="px-6 py-4 font-bold text-white flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-discord-element flex items-center justify-center text-discord-brand">
                            <i class="fa-solid fa-file-zipper" aria-hidden="true"></i>
                        </div>
                        ${escapeHtml(batch.original_name)}
                    </td>
                    <td class="px-6 py-4 text-discord-light font-mono text-xs">${formatBytes(batch.total_size)}</td>
                    <td class="px-6 py-4 text-discord-light font-mono text-xs hidden lg:table-cell">${formatDate(batch.upload_date)}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 lg:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="w-8 h-8 rounded-full bg-discord-element hover:bg-discord-brand text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Download" aria-label="Download batch ${escapeHtml(batch.batch_id)}" data-action="download" data-id="${escapeHtml(batch.batch_id)}"><i class="fa-solid fa-download" aria-hidden="true"></i></button>
                            <button class="w-8 h-8 rounded-full bg-discord-element hover:bg-green-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Verify" aria-label="Verify batch ${escapeHtml(batch.batch_id)}" data-action="verify" data-id="${escapeHtml(batch.batch_id)}"><i class="fa-solid fa-check" aria-hidden="true"></i></button>
                            <button class="w-8 h-8 rounded-full bg-discord-element hover:bg-red-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Delete" aria-label="Delete batch ${escapeHtml(batch.batch_id)}" data-action="delete" data-id="${escapeHtml(batch.batch_id)}"><i class="fa-solid fa-trash" aria-hidden="true"></i></button>
                        </div>
                    </td>
                `;
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'hidden bg-discord-bg/40';
                detailsRow.dataset.batchDetails = batch.batch_id;
                const title = escapeHtml(batch.title || 'â€”');
                const tags = escapeHtml(batch.tags || 'â€”');
                const description = escapeHtml(batch.description || 'â€”');
                const channel = batch.storage_channel_name ? `<i class="fa-solid fa-hashtag mr-1"></i>${escapeHtml(batch.storage_channel_name)}` : 'â€”';
                detailsRow.innerHTML = `
                    <td colspan="6" class="px-6 py-4">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 text-sm">
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Title</div>
                                <div class="text-white font-semibold break-words">${title}</div>
                            </div>
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Tags</div>
                                <div class="text-discord-light break-words">${tags}</div>
                            </div>
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Storage Channel</div>
                                <div class="text-discord-brand break-words">${channel}</div>
                            </div>
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Description</div>
                                <div class="text-discord-light break-words">${description}</div>
                            </div>
                        </div>
                    </td>
                `;
                table.appendChild(row);
                table.appendChild(detailsRow);
            });
        };

        const renderBatchesGrid = (batchesToRender) => {
            const grid = document.getElementById('batch-grid');
            grid.innerHTML = '';

            batchesToRender.forEach((batch) => {
                const card = document.createElement('div');
                card.className = 'border border-discord-divider/70 bg-discord-element/40 rounded-2xl p-4 flex flex-col gap-4 hover:border-discord-brand/40 transition-colors';
                const title = escapeHtml(batch.title || 'â€”');
                const tags = escapeHtml(batch.tags || 'â€”');
                const description = escapeHtml(batch.description || 'â€”');
                const channel = batch.storage_channel_name ? `<i class="fa-solid fa-hashtag mr-1"></i>${escapeHtml(batch.storage_channel_name)}` : 'â€”';
                const statusBadge = getStatusBadge(batch.status);

                card.innerHTML = `
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-xl bg-discord-bg/60 flex items-center justify-center text-discord-brand">
                                <i class="fa-solid fa-file-zipper"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="text-white font-semibold truncate">${escapeHtml(batch.original_name)}</div>
                                <div class="text-xs text-discord-light font-mono">#${escapeHtml(batch.batch_id)}</div>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-xs text-discord-light">
                        <div class="bg-discord-bg/60 border border-discord-divider/60 rounded-lg px-3 py-2">
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Size</div>
                            <div class="text-white font-semibold">${formatBytes(batch.total_size)}</div>
                        </div>
                        <div class="bg-discord-bg/60 border border-discord-divider/60 rounded-lg px-3 py-2">
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Date</div>
                            <div class="text-white font-semibold">${formatDate(batch.upload_date)}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-3 text-xs">
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Title</div>
                            <div class="text-white break-words">${title}</div>
                        </div>
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Tags</div>
                            <div class="text-discord-light break-words">${tags}</div>
                        </div>
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Storage Channel</div>
                            <div class="text-discord-brand break-words">${channel}</div>
                        </div>
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Description</div>
                            <div class="text-discord-light break-words">${description}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2 border-t border-discord-divider/60">
                        <button class="w-8 h-8 rounded-full bg-discord-bg/70 hover:bg-discord-brand text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Download" data-action="download" data-id="${batch.batch_id}"><i class="fa-solid fa-download"></i></button>
                        <button class="w-8 h-8 rounded-full bg-discord-bg/70 hover:bg-green-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Verify" data-action="verify" data-id="${batch.batch_id}"><i class="fa-solid fa-check"></i></button>
                        <button class="w-8 h-8 rounded-full bg-discord-bg/70 hover:bg-red-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Delete" data-action="delete" data-id="${batch.batch_id}"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        const renderBatches = () => {
            const emptyState = document.getElementById('empty-state');
            const tableContainer = document.getElementById('batch-table-container');
            const grid = document.getElementById('batch-grid');
            const batchCount = document.getElementById('batch-count');
            const batchesToRender = getFilteredBatches();

            // Update batch count
            if (batchCount) {
                const total = allBatches.length;
                const filtered = batchesToRender.length;
                if (total === filtered) {
                    batchCount.textContent = `${total} ${total === 1 ? 'batch' : 'batches'}`;
                } else {
                    batchCount.textContent = `${filtered} of ${total}`;
                }
            }

            if (!batchesToRender || batchesToRender.length === 0) {
                emptyState.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                grid.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            if (batchView === 'grid') {
                tableContainer.classList.add('hidden');
                grid.classList.remove('hidden');
                renderBatchesGrid(batchesToRender);
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                renderBatchesList(batchesToRender);
            }
        };

        const loadBatches = async () => {
            try {
                const res = await fetch('/api/batches');
                const batches = await res.json();
                allBatches = Array.isArray(batches) ? batches : [];
                renderBatches();
                renderActivity();
            } catch (e) { console.log("Batches load error"); }
        };

        const loadChannels = async () => {
            try {
                const res = await fetch('/api/channels');
                const data = await res.json();
                const channelSelect = document.getElementById('upload-channel');
                
                // Clear existing options except the first (Auto)
                channelSelect.innerHTML = '<option value="">Auto (Round-Robin Distribution)</option>';
                
                // Add channels from config
                if (data.channels && Array.isArray(data.channels)) {
                    data.channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel;
                        option.textContent = channel;
                        channelSelect.appendChild(option);
                    });
                }
            } catch (e) { 
                console.log("Channels load error", e); 
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Restore batch view preference from localStorage
            try {
                const savedView = localStorage.getItem('disbucket_batch_view');
                if (savedView === 'grid' || savedView === 'list') {
                    batchView = savedView;
                }
            } catch (e) {
                console.log('LocalStorage not available');
            }
            
            switchView('dashboard');
            loadStats();
            loadBatches();
            loadChannels();
            updateBatchViewToggle(batchView);
            updateLastUpdatedTime();
        });

        if (globalSearchInput) {
            globalSearchInput.addEventListener('input', () => {
                const value = globalSearchInput.value;
                if (value.trim()) {
                    switchView('batches');
                    if (batchSearchInput) {
                        batchSearchInput.value = value;
                        batchSearchTerm = value;
                        globalSearchTerm = '';
                    } else {
                        globalSearchTerm = value;
                    }
                } else {
                    globalSearchTerm = '';
                    if (batchSearchInput) {
                        batchSearchInput.value = '';
                        batchSearchTerm = '';
                    }
                }
                renderBatches();
            });
        }

        if (batchSearchInput) {
            batchSearchInput.addEventListener('input', () => {
                batchSearchTerm = batchSearchInput.value;
                renderBatches();
            });
        }

        document.getElementById('batch-view-grid').addEventListener('click', () => {
            setBatchView('grid');
        });

        document.getElementById('batch-view-list').addEventListener('click', () => {
            setBatchView('list');
        });

        document.getElementById('refresh-btn').addEventListener('click', async () => {
            const btn = document.getElementById('refresh-btn');
            const icon = btn.querySelector('i');
            btn.disabled = true;
            icon.classList.add('fa-spin');
            
            try {
                await Promise.all([loadStats(), loadBatches()]);
                showToast('Data refreshed successfully', 'success');
            } catch (e) {
                showToast('Failed to refresh data', 'error');
            } finally {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    btn.disabled = false;
                }, 500);
            }
        });

        const getFolderRootName = (files) => {
            if (!files || files.length === 0) return '';
            const sample = files[0].webkitRelativePath || '';
            if (!sample.includes('/')) return '';
            return sample.split('/')[0];
        };

        document.getElementById('upload-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const fileInput = document.getElementById('upload-file');
            const titleInput = document.getElementById('upload-title');
            const submitBtn = document.getElementById('submit-upload-btn');
            const submitIcon = submitBtn.querySelector('i');
            const submitText = submitBtn.querySelector('span');
            
            if (!fileInput.files.length) {
                showToast('Please select a file or folder to upload', 'warning');
                return;
            }
            
            // Add loading state
            submitBtn.disabled = true;
            submitIcon.className = 'fa-solid fa-spinner fa-spin';
            submitText.textContent = 'Uploading...';
            
            const formData = new FormData();
            Array.from(fileInput.files).forEach((file) => {
                formData.append('files', file);
            });
            if (uploadToggle.checked) {
                const rootName = getFolderRootName(fileInput.files)
                    || titleInput.value.trim()
                    || window.prompt('Folder name to preserve', '');
                if (rootName) {
                    formData.append('root_name', rootName.trim());
                }
            }
            formData.append('title', document.getElementById('upload-title').value);
            formData.append('tags', document.getElementById('upload-tags').value);
            formData.append('description', document.getElementById('upload-description').value);
            formData.append('channel', document.getElementById('upload-channel').value);
            formData.append('confirm', document.getElementById('upload-confirm').checked);
            
            try {
                const res = await fetch('/api/jobs/upload', { method: 'POST', body: formData });
                const data = await res.json();
                showToast('Upload job started successfully', 'success');
                startJob(data.job_id);
            } catch(e) { 
                showToast('Upload failed to start', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitIcon.className = 'fa-solid fa-rocket';
                submitText.textContent = 'Start Upload';
            }
        });

        const toggleBatchDetails = (batchId) => {
            const detailsRow = document.querySelector(`tr[data-batch-details="${batchId}"]`);
            const mainRow = document.querySelector(`tr[data-batch-id="${batchId}"]`);
            if (!detailsRow) return;
            
            const isExpanded = !detailsRow.classList.contains('hidden');
            detailsRow.classList.toggle('hidden');
            
            // Update chevron rotation
            const chevron = mainRow?.querySelector('.chevron-icon');
            if (chevron) {
                if (isExpanded) {
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    chevron.style.transform = 'rotate(90deg)';
                }
            }
            
            // Update aria-expanded
            if (mainRow) {
                mainRow.setAttribute('aria-expanded', !isExpanded);
            }
        };

        const handleBatchAction = async (action, batchId) => {
            try {
                if (action === 'download') {
                    const res = await fetch('/api/jobs/download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ batch_id: batchId })
                    });
                    const data = await res.json();
                    showToast('Download job started', 'info');
                    startJob(data.job_id);
                }
                else if (action === 'verify') {
                    const res = await fetch('/api/jobs/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ batch_id: batchId })
                    });
                    const data = await res.json();
                    showToast('Verification job started', 'info');
                    startJob(data.job_id);
                }
                else if (action === 'delete') {
                    if (!confirm('Are you sure you want to delete this batch locally?')) return;
                    const deleteRemote = confirm('Should we also delete the remote Discord thread?');
                    
                    const res = await fetch('/api/jobs/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ batch_id: batchId, delete_remote: deleteRemote })
                    });
                    const data = await res.json();
                    showToast('Delete job started', 'info');
                    startJob(data.job_id);
                }
            } catch(e) { 
                console.error("Action failed", e);
                showToast('Action failed to start', 'error');
            }
        };

        const handleTableInteraction = async (event) => {
            const button = event.target.closest('button');
            if (button) {
                event.stopPropagation();
                const action = button.dataset.action;
                const batchId = button.dataset.id;

                if (!action) return;

                await handleBatchAction(action, batchId);
                return;
            }

            const row = event.target.closest('tr');
            if (!row || !row.dataset.batchId) return;
            toggleBatchDetails(row.dataset.batchId);
        };
        
        document.getElementById('batch-table').addEventListener('click', handleTableInteraction);
        
        // Keyboard support for batch table rows
        document.getElementById('batch-table').addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                handleTableInteraction(event);
            }
        });

        document.getElementById('batch-grid').addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const batchId = button.dataset.id;
            if (!action) return;
            await handleBatchAction(action, batchId);
        });

        const bindAction = (id, endpoint, body) => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', async () => {
                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const data = await res.json();
                        startJob(data.job_id);
                    } catch(e) { console.error("System action failed"); }
                });
            }
        };

        bindAction('sync-btn', '/api/jobs/sync', { reset: false });
        bindAction('sync-reset-btn', '/api/jobs/sync', { reset: true });
        bindAction('backup-btn', '/api/jobs/backup', { upload_to_discord: false });
        bindAction('backup-upload-btn', '/api/jobs/backup', { upload_to_discord: true });

        updateUploadMode();
        
        // Add notification container for better toast positioning
        const notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        notificationContainer.className = 'fixed top-24 right-4 lg:right-8 z-50 flex flex-col gap-2 pointer-events-none';
        notificationContainer.setAttribute('aria-live', 'polite');
        notificationContainer.setAttribute('aria-atomic', 'true');
        document.body.appendChild(notificationContainer);
    </script>
</body>
</html>
