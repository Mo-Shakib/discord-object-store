<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DisBucket - Web UI</title>
    <meta name="description" content="Manage Discord Object Store batches with a modern web UI.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        discord: {
                            bg: '#313338',
                            sidebar: '#2b2d31',
                            element: '#1e1f22',
                            hover: '#3f4147',
                            active: '#35373c',
                            light: '#b5bac1',
                            white: '#f2f3f5',
                            divider: '#1f2023',
                            brand: '#5865F2',
                            brandHover: '#4752c4',
                            success: '#23a559',
                            danger: '#da373c',
                            warning: '#f0b232',
                            info: '#00a8fc'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 10s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(88, 101, 242, 0.15)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background-color: #2b2d31; 
        }
        ::-webkit-scrollbar-thumb {
            background-color: #1a1b1e; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #5865F2;
        }

        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .view-section.active {
            display: block;
            opacity: 1;
        }

        input[type="text"], textarea {
            outline: none;
            transition: all 0.2s ease;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #5865F2;
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
        }

        .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23B5BAC144' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%235865F2' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            background-color: rgba(88, 101, 242, 0.05);
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }
    </style>
</head>
<body class="bg-discord-bg text-discord-white font-sans h-screen flex overflow-hidden selection:bg-discord-brand selection:text-white">

    <aside class="w-72 bg-discord-sidebar flex flex-col border-r border-discord-divider shrink-0 z-30 shadow-xl">
        <div class="h-20 flex items-center px-6 border-b border-discord-divider shrink-0 gap-3">
            <div class="w-10 h-10 rounded-xl bg-discord-brand flex items-center justify-center shadow-glow">
                <i class="fa-solid fa-cubes text-2xl text-white"></i>
            </div>
            <div>
                <h1 class="font-extrabold text-lg tracking-tight leading-none text-white">DisBucket - Web UI</h1>
                <span class="text-[10px] font-mono text-discord-brand uppercase tracking-wider font-bold">Version v4.0.0</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <div class="text-xs font-bold text-discord-light uppercase tracking-wider px-4 mb-2 opacity-80">Menu</div>
            
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3 rounded-xl transition-all group active text-discord-white bg-discord-brand/10 text-discord-brand">
                <i class="fa-solid fa-chart-pie w-6 text-center text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-medium text-sm ml-3">Dashboard</span>
            </button>

            <button onclick="switchView('upload')" id="nav-upload" class="nav-item w-full flex items-center px-4 py-3 text-discord-light hover:bg-discord-hover hover:text-discord-white rounded-xl transition-all group">
                <i class="fa-solid fa-cloud-arrow-up w-6 text-center text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-medium text-sm ml-3">Upload Artifact</span>
            </button>

            <button onclick="switchView('batches')" id="nav-batches" class="nav-item w-full flex items-center px-4 py-3 text-discord-light hover:bg-discord-hover hover:text-discord-white rounded-xl transition-all group">
                <i class="fa-solid fa-layer-group w-6 text-center text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-medium text-sm ml-3">File Batches</span>
            </button>

            <div class="my-4 border-t border-discord-divider mx-2"></div>
            <div class="text-xs font-bold text-discord-light uppercase tracking-wider px-4 mb-2 opacity-80">System</div>

            <button onclick="switchView('actions')" id="nav-actions" class="nav-item w-full flex items-center px-4 py-3 text-discord-light hover:bg-discord-hover hover:text-discord-white rounded-xl transition-all group">
                <i class="fa-solid fa-sliders w-6 text-center text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-medium text-sm ml-3">Maintenance</span>
            </button>
        </nav>

        <div class="p-4 bg-discord-element/50 border-t border-discord-divider shrink-0">
            <div class="flex items-center gap-3 bg-discord-bg/50 p-3 rounded-xl border border-discord-divider/50">
                <div class="relative">
                    <div class="w-10 h-10 rounded-full bg-discord-element flex items-center justify-center border border-discord-divider">
                        <i class="fa-solid fa-server text-discord-light"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-discord-bg rounded-full flex items-center justify-center">
                        <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse-slow shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="text-sm font-bold text-white truncate">DisBucket Server</div>
                    <div class="text-[11px] text-discord-light font-mono truncate">Web UI: <span class="text-green-400">Connected</span></div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-discord-bg">
        <!-- Animated Gradient Blobs -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none z-0 opacity-50">
            <div class="absolute top-[-10%] left-[-5%] w-[500px] h-[500px] bg-discord-brand/30 rounded-full blur-[120px] animate-blob"></div>
            <div class="absolute bottom-[5%] right-[-5%] w-[450px] h-[450px] bg-purple-600/25 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
            <div class="absolute top-[20%] right-[10%] w-[400px] h-[400px] bg-blue-500/20 rounded-full blur-[110px] animate-blob animation-delay-4000"></div>
        </div>

        <header class="h-20 bg-discord-bg/95 backdrop-blur-sm border-b border-discord-divider flex items-center justify-between px-8 shrink-0 z-20 sticky top-0">
            <div class="flex flex-col justify-center">
                 <h2 id="page-title" class="text-xl font-bold text-white tracking-tight">Dashboard</h2>
                 <div class="flex items-center text-xs text-discord-light mt-1 font-mono">
                    <i class="fa-solid fa-folder-tree mr-2 opacity-60"></i>
                    <span>root</span>
                    <span class="mx-2 opacity-30">/</span>
                    <span id="breadcrumb-current" class="text-discord-brand">overview</span>
                 </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-discord-light group-focus-within:text-discord-brand transition-colors"></i>
                    <input id="global-search" type="text" placeholder="Global Search..." class="bg-discord-element border border-discord-divider rounded-full py-2 pl-10 pr-4 text-sm w-64 text-white focus:w-72 transition-all shadow-sm">
                </div>
                <button id="refresh-btn" class="w-10 h-10 rounded-full bg-discord-element hover:bg-discord-brand text-discord-light hover:text-white border border-discord-divider hover:border-discord-brand transition-all flex items-center justify-center shadow-sm" title="Refresh Data">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 scroll-smooth relative z-10" id="main-container">
            
            <section id="dashboard" class="view-section active animate-fade-in space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300 shadow-card">
                        <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-20 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Total Batches</h3>
                                <div id="stat-batches" class="text-3xl font-extrabold text-white">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 border border-purple-500/20">
                                <i class="fa-solid fa-layer-group"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            <span class="text-green-400"><i class="fa-solid fa-arrow-up"></i> Live</span> tracking enabled
                        </div>
                    </div>

                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300 shadow-card">
                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-20 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-hard-drive"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Total Size</h3>
                                <div id="stat-total" class="text-3xl font-extrabold text-white">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-400 border border-green-500/20">
                                <i class="fa-solid fa-hard-drive"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            Remote storage usage
                        </div>
                    </div>

                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300 shadow-card">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-20 group-hover:scale-110 transition-transform">
                            <i class="fa-regular fa-file-zipper"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Compressed</h3>
                                <div id="stat-compressed" class="text-3xl font-extrabold text-white">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
                                <i class="fa-regular fa-file-zipper"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            Optimized storage
                        </div>
                    </div>

                    <div class="bg-discord-sidebar rounded-2xl p-6 border border-discord-divider relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300 shadow-card">
                        <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>
                        <div class="absolute -right-6 -bottom-6 text-9xl text-discord-element opacity-20 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-puzzle-piece"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-discord-light text-xs font-bold uppercase tracking-wider mb-1">Chunks</h3>
                                <div id="stat-chunks" class="text-3xl font-extrabold text-white">--</div>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-yellow-500/10 flex items-center justify-center text-yellow-500 border border-yellow-500/20">
                                <i class="fa-solid fa-puzzle-piece"></i>
                            </div>
                        </div>
                        <div class="text-xs text-discord-light relative z-10">
                            Distributed file parts
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 animate-slide-up">
                    <div class="bg-discord-element rounded-2xl border border-discord-divider flex flex-col shadow-2xl overflow-hidden min-h-[400px]">
                        <div class="bg-[#2b2d31] px-5 py-3 border-b border-discord-divider flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="flex gap-2">
                                    <div class="w-3 h-3 rounded-full bg-[#ff5f57] hover:bg-[#ff5f57]/80 cursor-pointer"></div>
                                    <div class="w-3 h-3 rounded-full bg-[#febc2e] hover:bg-[#febc2e]/80 cursor-pointer"></div>
                                    <div class="w-3 h-3 rounded-full bg-[#28c840] hover:bg-[#28c840]/80 cursor-pointer"></div>
                                </div>
                                <div class="h-4 w-[1px] bg-discord-divider"></div>
                                <span class="font-mono text-xs text-discord-light flex items-center gap-2">
                                    <i class="fa-solid fa-terminal text-discord-brand"></i>
                                    bot.py — active job
                                </span>
                            </div>
                            <div id="job-summary" class="text-xs font-mono font-bold text-discord-light uppercase bg-discord-bg px-3 py-1 rounded-md border border-discord-divider">
                                IDLE
                            </div>
                        </div>

                        <div class="h-1 bg-discord-bg w-full">
                            <div id="job-progress" class="h-full bg-gradient-to-r from-discord-brand to-purple-500 transition-all duration-300 ease-out shadow-[0_0_10px_rgba(88,101,242,0.5)]" style="width: 0%;"></div>
                        </div>
                        
                        <pre id="job-logs" class="flex-1 p-6 font-mono text-sm text-discord-light/90 whitespace-pre-wrap overflow-y-auto custom-scrollbar selection:bg-discord-brand selection:text-white leading-relaxed">
<span class="text-discord-brand">➜</span> System initialized.
<span class="text-discord-brand">➜</span> Waiting for job dispatch...
                        </pre>
                    </div>
                </div>

                <div class="bg-discord-sidebar rounded-2xl border border-discord-divider shadow-card">
                    <div class="px-6 py-4 border-b border-discord-divider flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-xl bg-discord-element flex items-center justify-center text-discord-brand">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                            <div>
                                <h3 class="text-base font-bold text-white">Activity & Insights</h3>
                                <p class="text-xs text-discord-light">Last 7 days of storage activity</p>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-discord-brand bg-discord-brand/10 px-3 py-1 rounded-full border border-discord-brand/20">Live</span>
                    </div>
                    <div class="px-6 py-5 space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-2xl p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <div class="text-xs text-discord-light uppercase tracking-wider font-bold">Upload Volume</div>
                                        <div id="upload-volume-total" class="text-lg font-bold text-white mt-1">-- batches</div>
                                    </div>
                                    <span id="upload-volume-trend" class="text-xs font-mono text-discord-light bg-discord-bg/60 border border-discord-divider/60 px-2 py-1 rounded-full">--</span>
                                </div>
                                <div id="upload-volume-bars" class="flex items-end gap-2 h-28"></div>
                                <div id="upload-volume-labels" class="flex justify-between text-[10px] text-discord-light mt-3 font-mono"></div>
                            </div>
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-2xl p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <div class="text-xs text-discord-light uppercase tracking-wider font-bold">Storage Growth</div>
                                        <div id="storage-growth-total" class="text-lg font-bold text-white mt-1">--</div>
                                    </div>
                                    <span id="storage-growth-trend" class="text-xs font-mono text-discord-light bg-discord-bg/60 border border-discord-divider/60 px-2 py-1 rounded-full">--</span>
                                </div>
                                <div class="h-28 bg-discord-bg/60 rounded-xl border border-discord-divider/60 p-3">
                                    <svg viewBox="0 0 200 60" class="w-full h-full">
                                        <defs>
                                            <linearGradient id="growthLine" x1="0" y1="0" x2="1" y2="0">
                                                <stop offset="0%" stop-color="#5865F2" />
                                                <stop offset="100%" stop-color="#8b5cf6" />
                                            </linearGradient>
                                        </defs>
                                        <path id="storage-growth-line" d="M5 50 L35 42 L65 38 L95 30 L125 24 L155 18 L195 12" fill="none" stroke="url(#growthLine)" stroke-width="3" stroke-linecap="round" />
                                        <path id="storage-growth-area" d="M5 50 L35 42 L65 38 L95 30 L125 24 L155 18 L195 12 L195 60 L5 60 Z" fill="url(#growthLine)" opacity="0.15" />
                                    </svg>
                                </div>
                                <div id="storage-growth-labels" class="flex justify-between text-[10px] text-discord-light mt-3 font-mono"></div>
                            </div>
                        </div>
                        <div class="bg-discord-element/40 border border-discord-divider/60 rounded-2xl p-5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold">Recent Activity</div>
                                <span id="activity-updated" class="text-[10px] text-discord-light font-mono">Updated just now</span>
                            </div>
                            <div id="activity-feed" class="space-y-3 text-sm text-discord-light">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="upload" class="view-section animate-fade-in space-y-6 max-w-4xl mx-auto">
                <div class="bg-discord-sidebar rounded-2xl border border-discord-divider overflow-hidden shadow-card">
                    <div class="p-6 border-b border-discord-divider">
                        <h2 class="text-2xl font-bold text-white mb-1">Upload New Artifact</h2>
                        <p class="text-discord-light text-sm">Select files or folders to compress and upload to the Object Store.</p>
                    </div>
                    
                    <div class="p-8">
                        <form id="upload-form" class="space-y-5">
                            <div class="space-y-3">
                                <!-- <label class="text-xs font-bold text-discord-light uppercase tracking-wide">File Selection</label> -->
                                <div id="drop-area" class="drop-zone rounded-2xl p-4 flex flex-col items-center justify-center text-center cursor-pointer min-h-[140px] relative group">
                                    <input id="upload-file" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                    
                                    <div class="w-16 h-16 bg-discord-brand/10 rounded-full flex items-center justify-center text-discord-brand mb-4 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                                    </div>
                                    <h3 class="text-white font-bold text-lg mb-1">Click to browse or drag file here</h3>
                                    <p class="text-discord-light text-sm max-w-xs mx-auto">Supports individual files or directory structures (when folder mode is active).</p>
                                    <div id="file-name-display" class="mt-4 px-4 py-2 bg-discord-brand rounded-full text-xs font-bold text-white hidden animate-fade-in">
                                        <i class="fa-solid fa-file mr-2"></i> <span id="selected-filename">filename.zip</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 mt-2 pl-1">
                                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="upload-folder-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-all duration-300"/>
                                        <label for="upload-folder-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-discord-element border border-discord-divider cursor-pointer"></label>
                                    </div>
                                    <label for="upload-folder-toggle" class="text-sm font-medium text-discord-light cursor-pointer select-none">Upload as folder (preserves relative paths)</label>
                                </div>
                                <style>
                                    #upload-folder-toggle:checked + .toggle-label {
                                        background-color: #5865F2;
                                        border-color: #5865F2;
                                    }
                                    #upload-folder-toggle:checked {
                                        right: 0;
                                        border-color: #5865F2;
                                        transform: translateX(100%);
                                    }
                                </style>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">Artifact Title</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-discord-light/50"></i>
                                        <input id="upload-title" type="text" class="w-full bg-discord-element border border-discord-divider rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-discord-light/30 focus:border-discord-brand" placeholder="e.g. Project Phoenix Assets">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">Tags</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-hashtag absolute left-4 top-1/2 -translate-y-1/2 text-discord-light/50"></i>
                                        <input id="upload-tags" type="text" class="w-full bg-discord-element border border-discord-divider rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-discord-light/30 focus:border-discord-brand" placeholder="backup, v1, release">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-discord-light uppercase tracking-wide mb-2 block">Description</label>
                                <textarea id="upload-description" rows="2" class="w-full bg-discord-element border border-discord-divider rounded-xl p-4 text-sm text-white placeholder-discord-light/30 focus:border-discord-brand resize-none" placeholder="Brief summary of contents..."></textarea>
                            </div>

                            <div class="pt-6 border-t border-discord-divider flex items-center justify-between">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="w-5 h-5 rounded border border-discord-divider bg-discord-element flex items-center justify-center group-hover:border-discord-brand transition-colors">
                                        <input id="upload-confirm" type="checkbox" class="appearance-none w-full h-full checked:bg-discord-brand rounded-sm cursor-pointer">
                                        <i class="fa-solid fa-check text-white text-[10px] absolute opacity-0 check-icon pointer-events-none"></i>
                                        <style>
                                            #upload-confirm:checked + .check-icon { opacity: 1; }
                                        </style>
                                    </div>
                                    <span class="text-sm text-discord-light group-hover:text-white transition-colors">Require CLI Confirmation</span>
                                </label>
                                <button type="submit" class="bg-discord-brand hover:bg-discord-brandHover text-white px-10 py-3 rounded-full font-bold shadow-glow transition-all transform active:scale-95 text-sm flex items-center gap-2">
                                    <i class="fa-solid fa-rocket"></i> Start Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <section id="batches" class="view-section animate-fade-in space-y-6">
                 <div class="flex items-center justify-between bg-discord-sidebar p-2 rounded-2xl border border-discord-divider">
                    <div class="relative w-full max-w-md">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-discord-light"></i>
                        <input id="batch-search" type="text" placeholder="Filter batches..." class="w-full bg-transparent border-none rounded-xl py-3 pl-12 pr-4 text-white text-sm focus:ring-0 placeholder-discord-light/50">
                    </div>
                    <div class="flex gap-2 pr-2">
                         <button id="batch-view-grid" class="w-9 h-9 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light flex items-center justify-center transition-colors" title="Grid View">
                            <i class="fa-solid fa-grip"></i>
                         </button>
                         <button id="batch-view-list" class="w-9 h-9 rounded-lg bg-discord-brand text-white flex items-center justify-center shadow-sm" title="List View">
                            <i class="fa-solid fa-list"></i>
                         </button>
                    </div>
                </div>

                <div class="bg-discord-sidebar border border-discord-divider rounded-2xl overflow-hidden shadow-card">
                    <div id="batch-table-container" class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-discord-element border-b border-discord-divider text-left">
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider w-32">ID</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider">Artifact Name</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider">Size</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 font-mono text-xs font-bold text-discord-light uppercase tracking-wider text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="batch-table" class="divide-y divide-discord-divider">
                            </tbody>
                        </table>
                    </div>
                    <div id="batch-grid" class="hidden p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    </div>
                    <div id="empty-state" class="hidden p-12 flex flex-col items-center justify-center text-center">
                        <div class="w-16 h-16 bg-discord-element rounded-full flex items-center justify-center text-discord-light mb-4">
                            <i class="fa-solid fa-box-open text-3xl"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg">No Batches Found</h3>
                        <p class="text-discord-light text-sm mt-1">Upload a new artifact to get started.</p>
                    </div>
                </div>
            </section>

            <section id="actions" class="view-section animate-fade-in space-y-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-discord-sidebar border border-discord-divider flex items-center justify-center text-discord-light">
                        <i class="fa-solid fa-wrench"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">System Maintenance</h2>
                        <p class="text-xs text-discord-light">Manage local database and synchronization.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-discord-brand/50 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-arrows-rotate text-6xl text-white"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-white mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Sync from Discord</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Fetch latest metadata and verify integrity of remote channels.</p>
                        <button id="sync-btn" class="w-full bg-discord-element hover:bg-discord-brand hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all">
                            Run Sync
                        </button>
                    </div>

                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-red-500/50 transition-all group relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-bomb text-6xl text-red-500"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-red-500 mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-rotate-left"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Hard Reset</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Rebuild local DB from scratch. <span class="text-red-400">Destructive action.</span></p>
                        <button id="sync-reset-btn" class="w-full bg-discord-element hover:bg-red-500 hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all">
                            Run Reset
                        </button>
                    </div>

                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-green-500/50 transition-all group relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-floppy-disk text-6xl text-green-500"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-green-400 mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-floppy-disk"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Local Backup</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Dump local DB to a JSON file for safe keeping.</p>
                        <button id="backup-btn" class="w-full bg-discord-element hover:bg-green-600 hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all">
                            Create Backup
                        </button>
                    </div>

                    <div class="bg-discord-sidebar border border-discord-divider p-6 rounded-2xl hover:border-discord-brand/50 transition-all group relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-cloud-arrow-up text-6xl text-discord-brand"></i>
                        </div>
                        <div class="w-12 h-12 bg-discord-element rounded-xl flex items-center justify-center text-discord-brand mb-4 border border-discord-divider group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <h3 class="font-bold text-white mb-1">Cloud Backup</h3>
                        <p class="text-xs text-discord-light mb-6 min-h-[32px]">Backup DB and upload directly to a Discord thread.</p>
                        <button id="backup-upload-btn" class="w-full bg-discord-element hover:bg-discord-brand hover:text-white text-discord-light text-xs font-bold py-3 rounded-xl border border-discord-divider transition-all">
                            Backup + Upload
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        function switchView(viewName) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-discord-brand/10', 'text-discord-brand', 'active');
                el.classList.add('text-discord-light');
            });
            
            const activeNav = document.getElementById(`nav-${viewName}`);
            if (activeNav) {
                activeNav.classList.remove('text-discord-light');
                activeNav.classList.add('bg-discord-brand/10', 'text-discord-brand', 'active');
            }

            let displayName = viewName.charAt(0).toUpperCase() + viewName.slice(1);
            if (viewName === 'batches') displayName = 'File Batches';
            document.getElementById('breadcrumb-current').textContent = displayName.toLowerCase();
            document.getElementById('page-title').textContent = displayName;

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if (!el.classList.contains('active')) el.style.display = 'none';
                }, 200);
            });

            const target = document.getElementById(viewName);
            if (target) {
                target.style.display = 'block';
                void target.offsetWidth;
                target.classList.add('active');
            }
        }

        const uploadToggle = document.getElementById('upload-folder-toggle');
        const uploadInput = document.getElementById('upload-file');
        const fileNameDisplay = document.getElementById('selected-filename');
        const fileNameContainer = document.getElementById('file-name-display');
        const dropArea = document.getElementById('drop-area');

        const updateUploadMode = () => {
            if (uploadToggle.checked) {
                uploadInput.setAttribute('webkitdirectory', '');
                uploadInput.setAttribute('multiple', '');
            } else {
                uploadInput.removeAttribute('webkitdirectory');
                uploadInput.removeAttribute('multiple');
            }
            uploadInput.value = '';
            fileNameContainer.classList.add('hidden');
        };

        uploadToggle.addEventListener('change', updateUploadMode);
        
        uploadInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameContainer.classList.remove('hidden');
                if (this.files.length === 1) {
                    fileNameDisplay.textContent = this.files[0].name;
                } else {
                    fileNameDisplay.textContent = `${this.files.length} files selected`;
                }
            } else {
                fileNameContainer.classList.add('hidden');
            }
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('drag-over');
        }
        function unhighlight() {
            dropArea.classList.remove('drag-over');
        }

        const jobSummary = document.getElementById('job-summary');
        const jobLogs = document.getElementById('job-logs');
        const jobProgress = document.getElementById('job-progress');
        let activeJobId = null;
        let jobTimer = null;

        const formatBytes = (bytes) => {
            if (!bytes && bytes !== 0) return '--';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex += 1;
            }
            return `${size.toFixed(unitIndex === 0 ? 0 : 2)} ${units[unitIndex]}`;
        };

        const startJob = (jobId) => {
            activeJobId = jobId;
            jobSummary.textContent = `JOB #${jobId}`;
            jobSummary.className = "text-xs font-mono font-bold text-discord-brand uppercase bg-discord-brand/10 px-3 py-1 rounded-md border border-discord-brand/20";
            
            jobLogs.textContent = 'Initializing job sequence...\n';
            jobProgress.style.width = '0%';
            
            switchView('dashboard');
            
            if (jobTimer) clearInterval(jobTimer);
            jobTimer = setInterval(refreshJob, 1000);
            refreshJob();
        };

        const refreshJob = async () => {
            if (!activeJobId) return;
            try {
                const res = await fetch(`/api/jobs/${activeJobId}`);
                if (!res.ok) {
                    jobSummary.textContent = 'JOB NOT FOUND';
                    clearInterval(jobTimer);
                    return;
                }
                const data = await res.json();
                
                let statusColor = 'text-discord-light';
                if(data.status === 'complete') statusColor = 'text-green-400';
                if(data.status === 'failed') statusColor = 'text-red-400';
                if(data.status === 'running') statusColor = 'text-discord-brand';

                jobSummary.innerHTML = `<span class="${statusColor}"><i class="fa-solid fa-circle text-[8px] mr-2"></i>${data.type.toUpperCase()} • ${data.status.toUpperCase()}</span>`;
                
                const logs = (data.logs || []).slice();
                if (data.error) {
                    logs.push(`❌ CRITICAL ERROR: ${data.error}`);
                }
                if (data.result) {
                    logs.push(`✅ SUCCESS RESULT: ${JSON.stringify(data.result, null, 2)}`);
                }
                
                jobLogs.textContent = logs.join('\n');
                jobProgress.style.width = `${data.progress || 0}%`;
                jobLogs.scrollTop = jobLogs.scrollHeight;
                
                if (data.status === 'complete' || data.status === 'failed') {
                    clearInterval(jobTimer);
                    if(data.status === 'complete') {
                        loadStats();
                        loadBatches();
                    }
                }
            } catch (e) {
                console.error("Poll error", e);
            }
        };

        const loadStats = async () => {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stat-batches').textContent = stats.batch_count ?? '--';
                document.getElementById('stat-total').textContent = formatBytes(stats.total_size);
                document.getElementById('stat-compressed').textContent = formatBytes(stats.compressed_size);
                document.getElementById('stat-chunks').textContent = stats.chunk_count ?? '--';
            } catch (e) { console.log("Stats load error"); }
        };

        const globalSearchInput = document.getElementById('global-search');
        const batchSearchInput = document.getElementById('batch-search');
        let globalSearchTerm = '';
        let batchSearchTerm = '';
        let allBatches = [];

        const normalizeSearch = (value) => value.trim().toLowerCase();

        const getFilteredBatches = () => {
            const query = normalizeSearch(`${globalSearchTerm} ${batchSearchTerm}`);
            if (!query) return allBatches;
            const terms = query.split(/\s+/).filter(Boolean);
            return allBatches.filter((batch) => {
                const haystack = [
                    batch.batch_id,
                    batch.original_name,
                    batch.status,
                    batch.title,
                    batch.tags,
                    batch.description
                ].join(' ').toLowerCase();
                return terms.every((term) => haystack.includes(term));
            });
        };

        const formatDate = (value) => {
            if (!value) return '--';
            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) return '--';
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            return parsed.toLocaleDateString(undefined, {
                month: 'short',
                day: '2-digit',
                year: 'numeric',
                timeZone,
            });
        };

        const escapeHtml = (value) => {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        const renderActivity = () => {
            const feed = document.getElementById('activity-feed');
            const updated = document.getElementById('activity-updated');
            if (!feed || !updated) return;

            feed.innerHTML = '';
            const items = Array.isArray(allBatches) ? allBatches.slice(0, 3) : [];

            if (!items.length) {
                updated.textContent = 'No activity yet';
                feed.innerHTML = `
                    <div class="text-xs text-discord-light">Upload a batch to see activity.</div>
                `;
                return;
            }

            const statusMap = {
                complete: {
                    dot: 'bg-green-400',
                    title: 'Uploaded batch',
                },
                uploading: {
                    dot: 'bg-discord-brand',
                    title: 'Uploading batch',
                },
                failed: {
                    dot: 'bg-red-400',
                    title: 'Upload failed',
                },
            };

            items.forEach((batch) => {
                const statusInfo = statusMap[batch.status] || {
                    dot: 'bg-yellow-400',
                    title: 'Batch update',
                };
                const name = escapeHtml(batch.original_name || `Batch ${batch.batch_id}`);
                const fileCount = batch.file_count ? `${batch.file_count} files` : 'Files count unavailable';
                const when = formatDate(batch.upload_date);
                const shortId = escapeHtml(batch.batch_id ? batch.batch_id.slice(0, 6) : '');

                const item = document.createElement('div');
                item.className = 'flex items-start gap-3';
                item.innerHTML = `
                    <div class="w-2 h-2 rounded-full ${statusInfo.dot} mt-2"></div>
                    <div>
                        <div class="font-semibold text-white">${statusInfo.title}</div>
                        <div>${name} • ${fileCount} • ${when}${shortId ? ` • #${shortId}` : ''}</div>
                    </div>
                `;
                feed.appendChild(item);
            });

            updated.textContent = `Updated ${formatDate(items[0].upload_date)}`;
        };

        let batchView = 'list';

        const updateBatchViewToggle = (view) => {
            const gridBtn = document.getElementById('batch-view-grid');
            const listBtn = document.getElementById('batch-view-list');
            if (!gridBtn || !listBtn) return;

            if (view === 'grid') {
                gridBtn.className = 'w-9 h-9 rounded-lg bg-discord-brand text-white flex items-center justify-center shadow-sm';
                listBtn.className = 'w-9 h-9 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light flex items-center justify-center transition-colors';
            } else {
                listBtn.className = 'w-9 h-9 rounded-lg bg-discord-brand text-white flex items-center justify-center shadow-sm';
                gridBtn.className = 'w-9 h-9 rounded-lg bg-discord-element hover:bg-discord-hover text-discord-light flex items-center justify-center transition-colors';
            }
        };

        const setBatchView = (view) => {
            batchView = view;
            updateBatchViewToggle(view);
            renderBatches();
        };

        const toDayKey = (date) => {
            const local = new Date(date);
            if (Number.isNaN(local.getTime())) return null;
            return local.toLocaleDateString('en-CA');
        };

        const getLastNDays = (count) => {
            const days = [];
            const now = new Date();
            for (let i = count - 1; i >= 0; i -= 1) {
                const day = new Date(now);
                day.setDate(now.getDate() - i);
                days.push(day);
            }
            return days;
        };

        const renderInsights = () => {
            const volumeTotal = document.getElementById('upload-volume-total');
            const volumeTrend = document.getElementById('upload-volume-trend');
            const volumeBars = document.getElementById('upload-volume-bars');
            const volumeLabels = document.getElementById('upload-volume-labels');
            const growthTotal = document.getElementById('storage-growth-total');
            const growthTrend = document.getElementById('storage-growth-trend');
            const growthLine = document.getElementById('storage-growth-line');
            const growthArea = document.getElementById('storage-growth-area');
            const growthLabels = document.getElementById('storage-growth-labels');

            if (!volumeTotal || !volumeTrend || !volumeBars || !volumeLabels
                || !growthTotal || !growthTrend || !growthLine || !growthArea || !growthLabels) {
                return;
            }

            const rawDates = (allBatches || [])
                .map((batch) => toDayKey(batch.upload_date))
                .filter(Boolean);
            const uniqueKeys = Array.from(new Set(rawDates)).sort();
            const dayKeys = (uniqueKeys.length ? uniqueKeys.slice(-7) : getLastNDays(7).map((day) => toDayKey(day)));
            const days = dayKeys.map((key) => new Date(key));
            const byDay = dayKeys.reduce((acc, key) => {
                acc[key] = { batches: 0, size: 0 };
                return acc;
            }, {});

            (allBatches || []).forEach((batch) => {
                const key = toDayKey(batch.upload_date);
                if (!key || !(key in byDay)) return;
                byDay[key].batches += 1;
                byDay[key].size += Number(batch.total_size || 0);
            });

            const dailyBatches = dayKeys.map((key) => byDay[key].batches);
            const dailySize = dayKeys.map((key) => byDay[key].size);
            const totalBatches = dailyBatches.reduce((sum, val) => sum + val, 0);
            const totalSize = dailySize.reduce((sum, val) => sum + val, 0);
            const cumulativeSize = dailySize.reduce((acc, value, index) => {
                const nextValue = value + (acc[index - 1] || 0);
                acc.push(nextValue);
                return acc;
            }, []);

            volumeTotal.textContent = `${totalBatches} batches`;
            growthTotal.textContent = `+${formatBytes(totalSize)}`;

            const prevDays = uniqueKeys.length > 7 ? uniqueKeys.slice(-14, -7) : [];
            const prevBatches = (allBatches || []).reduce((sum, batch) => {
                const key = toDayKey(batch.upload_date);
                if (!key || !prevDays.includes(key)) return sum;
                return sum + 1;
            }, 0);
            const prevSize = (allBatches || []).reduce((sum, batch) => {
                const key = toDayKey(batch.upload_date);
                if (!key || !prevDays.includes(key)) return sum;
                return sum + Number(batch.total_size || 0);
            }, 0);

            const formatTrend = (current, previous, positiveClass, negativeClass) => {
                if (!previous) {
                    if (current > 0) {
                        return { text: '+100%', className: positiveClass };
                    }
                    return { text: '0%', className: 'text-discord-light bg-discord-bg/60 border border-discord-divider/60' };
                }
                const delta = ((current - previous) / previous) * 100;
                const sign = delta >= 0 ? '+' : '';
                return {
                    text: `${sign}${delta.toFixed(0)}%`,
                    className: delta >= 0 ? positiveClass : negativeClass,
                };
            };

            const volumeTrendInfo = formatTrend(
                totalBatches,
                prevBatches,
                'text-green-400 bg-green-500/10 border border-green-500/20',
                'text-red-400 bg-red-500/10 border border-red-500/20',
            );
            volumeTrend.textContent = volumeTrendInfo.text;
            volumeTrend.className = `text-xs font-mono px-2 py-1 rounded-full ${volumeTrendInfo.className}`;

            const growthTrendInfo = formatTrend(
                totalSize,
                prevSize,
                'text-green-400 bg-green-500/10 border border-green-500/20',
                'text-red-400 bg-red-500/10 border border-red-500/20',
            );
            growthTrend.textContent = growthTrendInfo.text;
            growthTrend.className = `text-xs font-mono px-2 py-1 rounded-full ${growthTrendInfo.className}`;

            const maxBatches = Math.max(1, ...dailyBatches);
            volumeBars.innerHTML = '';
            dailyBatches.forEach((count, index) => {
                const height = Math.max(10, Math.round((count / maxBatches) * 96));
                const bar = document.createElement('div');
                const tint = index >= 4 ? 'bg-purple-500/60' : 'bg-discord-brand/60';
                bar.className = `w-6 rounded-lg ${tint}`;
                bar.style.height = `${height}px`;
                bar.title = `${count} batches`;
                volumeBars.appendChild(bar);
            });

            volumeLabels.innerHTML = '';
            days.forEach((day) => {
                const label = document.createElement('span');
                label.textContent = day.toLocaleDateString(undefined, {
                    month: 'short',
                    day: '2-digit',
                });
                volumeLabels.appendChild(label);
            });

            const maxSize = Math.max(1, ...cumulativeSize);
            const points = cumulativeSize.map((value, index) => {
                const x = 5 + (index * (190 / 6));
                const y = 50 - (value / maxSize) * 38;
                return `${x.toFixed(1)} ${y.toFixed(1)}`;
            });
            const linePath = `M${points[0]} ` + points.slice(1).map((point) => `L${point}`).join(' ');
            growthLine.setAttribute('d', linePath);
            growthArea.setAttribute('d', `${linePath} L195 60 L5 60 Z`);

            growthLabels.innerHTML = '';
            const labelValues = [0, maxSize * 0.33, maxSize * 0.66, maxSize];
            labelValues.forEach((value) => {
                const label = document.createElement('span');
                label.textContent = formatBytes(Math.round(value));
                growthLabels.appendChild(label);
            });
        };

        const getStatusBadge = (status) => {
            if (status === 'complete') {
                return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-green-500/10 text-green-400 border border-green-500/20">Synced</span>`;
            }
            if (status === 'failed') {
                return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-red-500/10 text-red-400 border border-red-500/20">Failed</span>`;
            }
            if (status === 'uploading') {
                return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-discord-brand/10 text-discord-brand border border-discord-brand/20">Uploading</span>`;
            }
            return `<span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-discord-bg text-discord-light border border-discord-divider">${status}</span>`;
        };

        const renderBatchesList = (batchesToRender) => {
            const table = document.getElementById('batch-table');
            table.innerHTML = '';

            batchesToRender.forEach((batch) => {
                const row = document.createElement('tr');
                row.className = 'group hover:bg-discord-hover/50 transition-colors cursor-pointer';
                row.dataset.batchId = batch.batch_id;

                const statusBadge = getStatusBadge(batch.status);

                row.innerHTML = `
                    <td class="px-6 py-4 font-mono text-xs text-discord-light group-hover:text-white transition-colors">
                        <span class="opacity-70">#</span>${batch.batch_id}
                    </td>
                    <td class="px-6 py-4 font-bold text-white flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-discord-element flex items-center justify-center text-discord-brand">
                            <i class="fa-solid fa-file-zipper"></i>
                        </div>
                        ${batch.original_name}
                    </td>
                    <td class="px-6 py-4 text-discord-light font-mono text-xs">${formatBytes(batch.total_size)}</td>
                    <td class="px-6 py-4 text-discord-light font-mono text-xs">${formatDate(batch.upload_date)}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="w-8 h-8 rounded-full bg-discord-element hover:bg-discord-brand text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Download" data-action="download" data-id="${batch.batch_id}"><i class="fa-solid fa-download"></i></button>
                            <button class="w-8 h-8 rounded-full bg-discord-element hover:bg-green-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Verify" data-action="verify" data-id="${batch.batch_id}"><i class="fa-solid fa-check"></i></button>
                            <button class="w-8 h-8 rounded-full bg-discord-element hover:bg-red-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Delete" data-action="delete" data-id="${batch.batch_id}"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                `;
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'hidden bg-discord-bg/40';
                detailsRow.dataset.batchDetails = batch.batch_id;
                const title = escapeHtml(batch.title || '—');
                const tags = escapeHtml(batch.tags || '—');
                const description = escapeHtml(batch.description || '—');
                detailsRow.innerHTML = `
                    <td colspan="6" class="px-6 py-4">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Title</div>
                                <div class="text-white font-semibold break-words">${title}</div>
                            </div>
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Tags</div>
                                <div class="text-discord-light break-words">${tags}</div>
                            </div>
                            <div class="bg-discord-element/40 border border-discord-divider/60 rounded-xl p-4">
                                <div class="text-xs text-discord-light uppercase tracking-wider font-bold mb-2">Description</div>
                                <div class="text-discord-light break-words">${description}</div>
                            </div>
                        </div>
                    </td>
                `;
                table.appendChild(row);
                table.appendChild(detailsRow);
            });
        };

        const renderBatchesGrid = (batchesToRender) => {
            const grid = document.getElementById('batch-grid');
            grid.innerHTML = '';

            batchesToRender.forEach((batch) => {
                const card = document.createElement('div');
                card.className = 'border border-discord-divider/70 bg-discord-element/40 rounded-2xl p-4 flex flex-col gap-4 hover:border-discord-brand/40 transition-colors';
                const title = escapeHtml(batch.title || '—');
                const tags = escapeHtml(batch.tags || '—');
                const description = escapeHtml(batch.description || '—');
                const statusBadge = getStatusBadge(batch.status);

                card.innerHTML = `
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-xl bg-discord-bg/60 flex items-center justify-center text-discord-brand">
                                <i class="fa-solid fa-file-zipper"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="text-white font-semibold truncate">${escapeHtml(batch.original_name)}</div>
                                <div class="text-xs text-discord-light font-mono">#${escapeHtml(batch.batch_id)}</div>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-xs text-discord-light">
                        <div class="bg-discord-bg/60 border border-discord-divider/60 rounded-lg px-3 py-2">
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Size</div>
                            <div class="text-white font-semibold">${formatBytes(batch.total_size)}</div>
                        </div>
                        <div class="bg-discord-bg/60 border border-discord-divider/60 rounded-lg px-3 py-2">
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Date</div>
                            <div class="text-white font-semibold">${formatDate(batch.upload_date)}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-3 text-xs">
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Title</div>
                            <div class="text-white break-words">${title}</div>
                        </div>
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Tags</div>
                            <div class="text-discord-light break-words">${tags}</div>
                        </div>
                        <div>
                            <div class="uppercase tracking-wider text-[10px] text-discord-light/70">Description</div>
                            <div class="text-discord-light break-words">${description}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2 border-t border-discord-divider/60">
                        <button class="w-8 h-8 rounded-full bg-discord-bg/70 hover:bg-discord-brand text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Download" data-action="download" data-id="${batch.batch_id}"><i class="fa-solid fa-download"></i></button>
                        <button class="w-8 h-8 rounded-full bg-discord-bg/70 hover:bg-green-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Verify" data-action="verify" data-id="${batch.batch_id}"><i class="fa-solid fa-check"></i></button>
                        <button class="w-8 h-8 rounded-full bg-discord-bg/70 hover:bg-red-500 text-discord-light hover:text-white transition-all shadow-sm flex items-center justify-center" title="Delete" data-action="delete" data-id="${batch.batch_id}"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        const renderBatches = () => {
            const emptyState = document.getElementById('empty-state');
            const tableContainer = document.getElementById('batch-table-container');
            const grid = document.getElementById('batch-grid');
            const batchesToRender = getFilteredBatches();

            if (!batchesToRender || batchesToRender.length === 0) {
                emptyState.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                grid.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            if (batchView === 'grid') {
                tableContainer.classList.add('hidden');
                grid.classList.remove('hidden');
                renderBatchesGrid(batchesToRender);
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                renderBatchesList(batchesToRender);
            }
        };

        const loadBatches = async () => {
            try {
                const res = await fetch('/api/batches');
                const batches = await res.json();
                allBatches = Array.isArray(batches) ? batches : [];
                renderBatches();
                renderActivity();
                renderInsights();
            } catch (e) { console.log("Batches load error"); }
        };

        document.addEventListener('DOMContentLoaded', () => {
            switchView('dashboard');
            loadStats();
            loadBatches();
            updateBatchViewToggle(batchView);
        });

        if (globalSearchInput) {
            globalSearchInput.addEventListener('input', () => {
                const value = globalSearchInput.value;
                if (value.trim()) {
                    switchView('batches');
                    if (batchSearchInput) {
                        batchSearchInput.value = value;
                        batchSearchTerm = value;
                        globalSearchTerm = '';
                    } else {
                        globalSearchTerm = value;
                    }
                } else {
                    globalSearchTerm = '';
                    if (batchSearchInput) {
                        batchSearchInput.value = '';
                        batchSearchTerm = '';
                    }
                }
                renderBatches();
            });
        }

        if (batchSearchInput) {
            batchSearchInput.addEventListener('input', () => {
                batchSearchTerm = batchSearchInput.value;
                renderBatches();
            });
        }

        document.getElementById('batch-view-grid').addEventListener('click', () => {
            setBatchView('grid');
        });

        document.getElementById('batch-view-list').addEventListener('click', () => {
            setBatchView('list');
        });

        document.getElementById('refresh-btn').addEventListener('click', async () => {
            const btn = document.getElementById('refresh-btn');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            await loadStats();
            await loadBatches();
            setTimeout(() => icon.classList.remove('fa-spin'), 500);
        });

        const getFolderRootName = (files) => {
            if (!files || files.length === 0) return '';
            const sample = files[0].webkitRelativePath || '';
            if (!sample.includes('/')) return '';
            return sample.split('/')[0];
        };

        document.getElementById('upload-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const fileInput = document.getElementById('upload-file');
            const titleInput = document.getElementById('upload-title');
            if (!fileInput.files.length) {
                alert('Please select a file or folder to upload.');
                return;
            }
            const formData = new FormData();
            Array.from(fileInput.files).forEach((file) => {
                formData.append('files', file);
            });
            if (uploadToggle.checked) {
                const rootName = getFolderRootName(fileInput.files)
                    || titleInput.value.trim()
                    || window.prompt('Folder name to preserve', '');
                if (rootName) {
                    formData.append('root_name', rootName.trim());
                }
            }
            formData.append('title', document.getElementById('upload-title').value);
            formData.append('tags', document.getElementById('upload-tags').value);
            formData.append('description', document.getElementById('upload-description').value);
            formData.append('confirm', document.getElementById('upload-confirm').checked);
            
            try {
                const res = await fetch('/api/jobs/upload', { method: 'POST', body: formData });
                const data = await res.json();
                startJob(data.job_id);
            } catch(e) { alert("Upload failed to start."); }
        });

        const toggleBatchDetails = (batchId) => {
            const detailsRow = document.querySelector(`tr[data-batch-details="${batchId}"]`);
            if (!detailsRow) return;
            detailsRow.classList.toggle('hidden');
        };

        const handleBatchAction = async (action, batchId) => {
            try {
                if (action === 'download') {
                    const res = await fetch('/api/jobs/download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ batch_id: batchId })
                    });
                    const data = await res.json();
                    startJob(data.job_id);
                }
                else if (action === 'verify') {
                    const res = await fetch('/api/jobs/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ batch_id: batchId })
                    });
                    const data = await res.json();
                    startJob(data.job_id);
                }
                else if (action === 'delete') {
                    if (!confirm('Are you sure you want to delete this batch locally?')) return;
                    const deleteRemote = confirm('Should we also delete the remote Discord thread?');
                    
                    const res = await fetch('/api/jobs/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ batch_id: batchId, delete_remote: deleteRemote })
                    });
                    const data = await res.json();
                    startJob(data.job_id);
                }
            } catch(e) { console.error("Action failed", e); }
        };

        document.getElementById('batch-table').addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (button) {
                const action = button.dataset.action;
                const batchId = button.dataset.id;

                if (!action) return;

                await handleBatchAction(action, batchId);
                return;
            }

            const row = event.target.closest('tr');
            if (!row || !row.dataset.batchId) return;
            toggleBatchDetails(row.dataset.batchId);
        });

        document.getElementById('batch-grid').addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const batchId = button.dataset.id;
            if (!action) return;
            await handleBatchAction(action, batchId);
        });

        const bindAction = (id, endpoint, body) => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', async () => {
                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const data = await res.json();
                        startJob(data.job_id);
                    } catch(e) { console.error("System action failed"); }
                });
            }
        };

        bindAction('sync-btn', '/api/jobs/sync', { reset: false });
        bindAction('sync-reset-btn', '/api/jobs/sync', { reset: true });
        bindAction('backup-btn', '/api/jobs/backup', { upload_to_discord: false });
        bindAction('backup-upload-btn', '/api/jobs/backup', { upload_to_discord: true });

        updateUploadMode();
    </script>
</body>
</html>
